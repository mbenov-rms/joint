/*! JointJS v0.9.3 - JavaScript diagramming library  2015-04-20 


This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.g=b()}(this,function(){function a(b,c){if(!(this instanceof a))return new a(b,c);var d;void 0===c&&Object(b)!==b?(d=b.split(-1===b.indexOf("@")?" ":"@"),this.x=parseInt(d[0],10),this.y=parseInt(d[1],10)):Object(b)===b?(this.x=b.x,this.y=b.y):(this.x=b,this.y=c)}function b(c,d){return this instanceof b?(this.start=a(c),void(this.end=a(d))):new b(c,d)}function c(a,b,d,e){return this instanceof c?(void 0===b&&(b=a.y,d=a.width,e=a.height,a=a.x),this.x=a,this.y=b,this.width=d,void(this.height=e)):new c(a,b,d,e)}function d(b,c,e){return this instanceof d?(b=a(b),this.x=b.x,this.y=b.y,this.a=c,void(this.b=e)):new d(b,c,e)}var e=Math,f=e.abs,g=e.cos,h=e.sin,i=e.sqrt,j=e.min,k=e.max,l=(e.atan,e.atan2),m=(e.acos,e.round),n=e.floor,o=e.PI,p=e.random,q=function(a){return 180*a/o%360},r=function(a,b){return b=b||!1,a=b?a:a%360,a*o/180},s=function(a,b){return b*Math.round(a/b)},t=function(a){return a%360+(0>a?360:0)};a.prototype={toString:function(){return this.x+"@"+this.y},adhereToRect:function(a){return a.containsPoint(this)?this:(this.x=j(k(this.x,a.x),a.x+a.width),this.y=j(k(this.y,a.y),a.y+a.height),this)},theta:function(b){b=a(b);var c=-(b.y-this.y),d=b.x-this.x,e=10,f=0==c.toFixed(e)&&0==d.toFixed(e)?0:l(c,d);return 0>f&&(f=2*o+f),180*f/o},distance:function(a){return b(this,a).length()},manhattanDistance:function(a){return f(a.x-this.x)+f(a.y-this.y)},offset:function(a,b){return this.x+=a||0,this.y+=b||0,this},magnitude:function(){return i(this.x*this.x+this.y*this.y)||.01},update:function(a,b){return this.x=a||0,this.y=b||0,this},round:function(a){return this.x=a?this.x.toFixed(a):m(this.x),this.y=a?this.y.toFixed(a):m(this.y),this},normalize:function(a){var b=(a||1)/this.magnitude();return this.x=b*this.x,this.y=b*this.y,this},difference:function(b){return a(this.x-b.x,this.y-b.y)},bearing:function(a){return b(this,a).bearing()},toPolar:function(b){b=b&&a(b)||a(0,0);var c=this.x,d=this.y;return this.x=i((c-b.x)*(c-b.x)+(d-b.y)*(d-b.y)),this.y=r(b.theta(a(c,d))),this},rotate:function(b,c){c=(c+360)%360,this.toPolar(b),this.y+=r(c);var d=a.fromPolar(this.x,this.y,b);return this.x=d.x,this.y=d.y,this},move:function(b,c){var d=r(a(b).theta(this));return this.offset(g(d)*c,-h(d)*c)},changeInAngle:function(b,c,d){return a(this).offset(-b,-c).theta(d)-this.theta(d)},equals:function(a){return this.x===a.x&&this.y===a.y},snapToGrid:function(a,b){return this.x=s(this.x,a),this.y=s(this.y,b||a),this},reflection:function(b){return a(b).move(this,this.distance(b))}},a.fromPolar=function(b,c,d){d=d&&a(d)||a(0,0);var e=f(b*g(c)),i=f(b*h(c)),j=t(q(c));return 90>j?i=-i:180>j?(e=-e,i=-i):270>j&&(e=-e),a(d.x+e,d.y+i)},a.random=function(b,c,d,e){return a(n(p()*(c-b+1)+b),n(p()*(e-d+1)+d))},b.prototype={toString:function(){return this.start.toString()+" "+this.end.toString()},length:function(){return i(this.squaredLength())},squaredLength:function(){var a=this.start.x,b=this.start.y,c=this.end.x,d=this.end.y;return(a-=c)*a+(b-=d)*b},midpoint:function(){return a((this.start.x+this.end.x)/2,(this.start.y+this.end.y)/2)},intersection:function(b){var c=a(this.end.x-this.start.x,this.end.y-this.start.y),d=a(b.end.x-b.start.x,b.end.y-b.start.y),e=c.x*d.y-c.y*d.x,f=a(b.start.x-this.start.x,b.start.y-this.start.y),g=f.x*d.y-f.y*d.x,h=f.x*c.y-f.y*c.x;if(0===e||0>g*e||0>h*e)return null;if(e>0){if(g>e||h>e)return null}else if(e>g||e>h)return null;return a(this.start.x+g*c.x/e,this.start.y+g*c.y/e)},bearing:function(){var a=r(this.start.y),b=r(this.end.y),c=this.start.x,d=this.end.x,e=r(d-c),f=h(e)*g(b),i=g(a)*h(b)-h(a)*g(b)*g(e),j=q(l(f,i)),k=["NE","E","SE","S","SW","W","NW","N"],m=j-22.5;return 0>m&&(m+=360),m=parseInt(m/45),k[m]},pointAt:function(b){var c=(1-b)*this.start.x+b*this.end.x,d=(1-b)*this.start.y+b*this.end.y;return a(c,d)},pointOffset:function(a){return((this.end.x-this.start.x)*(a.y-this.start.y)-(this.end.y-this.start.y)*(a.x-this.start.x))/2}},c.prototype={toString:function(){return this.origin().toString()+" "+this.corner().toString()},origin:function(){return a(this.x,this.y)},corner:function(){return a(this.x+this.width,this.y+this.height)},topRight:function(){return a(this.x+this.width,this.y)},bottomLeft:function(){return a(this.x,this.y+this.height)},center:function(){return a(this.x+this.width/2,this.y+this.height/2)},intersect:function(a){var b=this.origin(),c=this.corner(),d=a.origin(),e=a.corner();return e.x<=b.x||e.y<=b.y||d.x>=c.x||d.y>=c.y?!1:!0},sideNearestToPoint:function(b){b=a(b);var c=b.x-this.x,d=this.x+this.width-b.x,e=b.y-this.y,f=this.y+this.height-b.y,g=c,h="left";return g>d&&(g=d,h="right"),g>e&&(g=e,h="top"),g>f&&(g=f,h="bottom"),h},containsPoint:function(b){return b=a(b),b.x>=this.x&&b.x<=this.x+this.width&&b.y>=this.y&&b.y<=this.y+this.height?!0:!1},containsRect:function(a){var b=c(a).normalize(),d=b.width,e=b.height,f=b.x,g=b.y,h=this.width,i=this.height;if(0>(h|i|d|e))return!1;var j=this.x,k=this.y;if(j>f||k>g)return!1;if(h+=j,d+=f,f>=d){if(h>=j||d>h)return!1}else if(h>=j&&d>h)return!1;if(i+=k,e+=g,g>=e){if(i>=k||e>i)return!1}else if(i>=k&&e>i)return!1;return!0},pointNearestToPoint:function(b){if(b=a(b),this.containsPoint(b)){var c=this.sideNearestToPoint(b);switch(c){case"right":return a(this.x+this.width,b.y);case"left":return a(this.x,b.y);case"bottom":return a(b.x,this.y+this.height);case"top":return a(b.x,this.y)}}return b.adhereToRect(this)},intersectionWithLineFromCenterToPoint:function(c,d){c=a(c);var e,f=a(this.x+this.width/2,this.y+this.height/2);d&&c.rotate(f,d);for(var g=[b(this.origin(),this.topRight()),b(this.topRight(),this.corner()),b(this.corner(),this.bottomLeft()),b(this.bottomLeft(),this.origin())],h=b(f,c),i=g.length-1;i>=0;--i){var j=g[i].intersection(h);if(null!==j){e=j;break}}return e&&d&&e.rotate(f,-d),e},moveAndExpand:function(a){return this.x+=a.x||0,this.y+=a.y||0,this.width+=a.width||0,this.height+=a.height||0,this},round:function(a){return this.x=a?this.x.toFixed(a):m(this.x),this.y=a?this.y.toFixed(a):m(this.y),this.width=a?this.width.toFixed(a):m(this.width),this.height=a?this.height.toFixed(a):m(this.height),this},normalize:function(){var a=this.x,b=this.y,c=this.width,d=this.height;return this.width<0&&(a=this.x+this.width,c=-this.width),this.height<0&&(b=this.y+this.height,d=-this.height),this.x=a,this.y=b,this.width=c,this.height=d,this},bbox:function(a){var b=r(a||0),d=f(h(b)),e=f(g(b)),i=this.width*e+this.height*d,j=this.width*d+this.height*e;return c(this.x+(this.width-i)/2,this.y+(this.height-j)/2,i,j)}},d.prototype={toString:function(){return a(this.x,this.y).toString()+" "+this.a+" "+this.b},bbox:function(){return c(this.x-this.a,this.y-this.b,2*this.a,2*this.b)},intersectionWithLineFromCenterToPoint:function(b,c){b=a(b),c&&b.rotate(a(this.x,this.y),c);var d,e=b.x-this.x,f=b.y-this.y;if(0===e)return d=this.bbox().pointNearestToPoint(b),c?d.rotate(a(this.x,this.y),-c):d;var g=f/e,h=g*g,j=this.a*this.a,k=this.b*this.b,l=i(1/(1/j+h/k));l=0>e?-l:l;var m=g*l;return d=a(this.x+l,this.y+m),c?d.rotate(a(this.x,this.y),-c):d}};var u={curveThroughPoints:function(a){for(var b=this.getCurveControlPoints(a),c=["M",a[0].x,a[0].y],d=0;d<b[0].length;d++)c.push("C",b[0][d].x,b[0][d].y,b[1][d].x,b[1][d].y,a[d+1].x,a[d+1].y);return c},getCurveControlPoints:function(b){var c,d=[],e=[],f=b.length-1;if(1==f)return d[0]=a((2*b[0].x+b[1].x)/3,(2*b[0].y+b[1].y)/3),e[0]=a(2*d[0].x-b[0].x,2*d[0].y-b[0].y),[d,e];var g=[];for(c=1;f-1>c;c++)g[c]=4*b[c].x+2*b[c+1].x;g[0]=b[0].x+2*b[1].x,g[f-1]=(8*b[f-1].x+b[f].x)/2;var h=this.getFirstControlPoints(g);for(c=1;f-1>c;++c)g[c]=4*b[c].y+2*b[c+1].y;g[0]=b[0].y+2*b[1].y,g[f-1]=(8*b[f-1].y+b[f].y)/2;var i=this.getFirstControlPoints(g);for(c=0;f>c;c++)d.push(a(h[c],i[c])),e.push(f-1>c?a(2*b[c+1].x-h[c+1],2*b[c+1].y-i[c+1]):a((b[f].x+h[f-1])/2,(b[f].y+i[f-1])/2));return[d,e]},getFirstControlPoints:function(a){var b=a.length,c=[],d=[],e=2;c[0]=a[0]/e;for(var f=1;b>f;f++)d[f]=1/e,e=(b-1>f?4:3.5)-d[f],c[f]=(a[f]-c[f-1])/e;for(f=1;b>f;f++)c[b-f-1]-=d[b-f]*c[b-f];return c},getInversionSolver:function(a,b,c,d){function e(a,b){var c=f[a],d=f[b];return function(e){var f=(a%3?3:1)*(b%3?3:1),g=e.x*(c.y-d.y)+e.y*(d.x-c.x)+c.x*d.y-c.y*d.x;return f*g}}var f=arguments;return function(c){var d=3*e(2,3)(b),f=e(1,3)(a)/d,g=-e(2,3)(a)/d,h=f*e(3,1)(c)+g*(e(3,0)(c)+e(2,1)(c))+e(2,0)(c),i=f*e(3,0)(c)+g*e(2,0)(c)+e(1,0)(c);return i/(i-h)}},getCurveDivider:function(a,c,d,e){return function(f){var g=b(a,c).pointAt(f),h=b(c,d).pointAt(f),i=b(d,e).pointAt(f),j=b(g,h).pointAt(f),k=b(h,i).pointAt(f),l=b(j,k).pointAt(f);return[{p0:a,p1:g,p2:j,p3:l},{p0:l,p1:k,p2:i,p3:e}]}}},v={linear:function(a,b,c){var d=a[1]-a[0],e=b[1]-b[0];return(c-a[0])/d*e+b[0]||0}};return{toDeg:q,toRad:r,snapToGrid:s,normalizeAngle:t,point:a,line:b,rect:c,ellipse:d,bezier:u,scale:v}}),function(a,b){if("function"==typeof define&&define.amd)define(["Geometry"],b);else if("object"==typeof exports){var c=require("G")||require("Geometry")||require("g");module.exports=b(c)}else{var c=a.G||a.Geometry||a.g;a.Vectorizer=a.V=b(c)}}(this,function(a){function b(){var a=++s+"";return"v-"+a}function c(a){var b='<svg xmlns="'+q.xmlns+'" xmlns:xlink="'+q.xlink+'" version="'+r+'">'+(a||"")+"</svg>",c=new DOMParser;return c.async=!1,c.parseFromString(b,"text/xml").documentElement}function d(a,b,d){var f,g;if(!a)return void 0;if("object"==typeof a)return new i(a);if(b=b||{},"svg"===a.toLowerCase())return new i(c());if("<"===a[0]){var h=c(a);if(h.childNodes.length>1){var j=[];for(f=0,g=h.childNodes.length;g>f;f++){var k=h.childNodes[f];j.push(new i(document.importNode(k,!0)))}return j}return new i(document.importNode(h.firstChild,!0))}a=document.createElementNS(q.xmlns,a);for(var l in b)e(a,l,b[l]);for("[object Array]"!=Object.prototype.toString.call(d)&&(d=[d]),f=0,g=d[0]&&d.length||0;g>f;f++){var m=d[f];a.appendChild(m instanceof i?m.node:m)}return new i(a)}function e(a,b,c){if(b.indexOf(":")>-1){var d=b.split(":");a.setAttributeNS(q[d[0]],d[1],c)}else"id"===b?a.id=c:a.setAttribute(b,c)}function f(a){var b,c,d;if(a){var e=/[ ,]+/,f=a.match(/translate\((.*)\)/);f&&(b=f[1].split(e));var g=a.match(/rotate\((.*)\)/);g&&(c=g[1].split(e));var h=a.match(/scale\((.*)\)/);h&&(d=h[1].split(e))}var i=d&&d[0]?parseFloat(d[0]):1;return{translate:{tx:b&&b[0]?parseInt(b[0],10):0,ty:b&&b[1]?parseInt(b[1],10):0},rotate:{angle:c&&c[0]?parseInt(c[0],10):0,cx:c&&c[1]?parseInt(c[1],10):void 0,cy:c&&c[2]?parseInt(c[2],10):void 0},scale:{sx:i,sy:d&&d[1]?parseFloat(d[1]):i}}}function g(a,b){var c=b.x*a.a+b.y*a.c+0,d=b.x*a.b+b.y*a.d+0;return{x:c,y:d}}function h(a){var b=g(a,{x:0,y:1}),c=g(a,{x:1,y:0}),d=180/Math.PI*Math.atan2(b.y,b.x)-90,e=180/Math.PI*Math.atan2(c.y,c.x);return{translateX:a.e,translateY:a.f,scaleX:Math.sqrt(a.a*a.a+a.b*a.b),scaleY:Math.sqrt(a.c*a.c+a.d*a.d),skewX:d,skewY:e,rotation:d}}function i(a){this.node=a,this.node.id||(this.node.id=b())}function j(a){a=d(a);var b=["M",a.attr("x1"),a.attr("y1"),"L",a.attr("x2"),a.attr("y2")].join(" ");return b}function k(a){a=d(a);for(var b,c=a.node.points,e=[],f=0;f<c.length;f++)b=c[f],e.push(0===f?"M":"L",b.x,b.y);return e.push("Z"),e.join(" ")}function l(a){a=d(a);for(var b,c=a.node.points,e=[],f=0;f<c.length;f++)b=c[f],e.push(0===f?"M":"L",b.x,b.y);return e.join(" ")}function m(a){a=d(a);var b=parseFloat(a.attr("cx"))||0,c=parseFloat(a.attr("cy"))||0,e=parseFloat(a.attr("r")),f=e*t,g=["M",b,c-e,"C",b+f,c-e,b+e,c-f,b+e,c,"C",b+e,c+f,b+f,c+e,b,c+e,"C",b-f,c+e,b-e,c+f,b-e,c,"C",b-e,c-f,b-f,c-e,b,c-e,"Z"].join(" ");return g}function n(a){a=d(a);var b=parseFloat(a.attr("cx"))||0,c=parseFloat(a.attr("cy"))||0,e=parseFloat(a.attr("rx")),f=parseFloat(a.attr("ry"))||e,g=e*t,h=f*t,i=["M",b,c-f,"C",b+g,c-f,b+e,c-h,b+e,c,"C",b+e,c+h,b+g,c+f,b,c+f,"C",b-g,c+f,b-e,c+h,b-e,c,"C",b-e,c-h,b-g,c-f,b,c-f,"Z"].join(" ");return i}function o(b){b=d(b);var c,e=parseFloat(b.attr("x"))||0,f=parseFloat(b.attr("y"))||0,g=parseFloat(b.attr("width"))||0,h=parseFloat(b.attr("height"))||0,i=parseFloat(b.attr("rx"))||0,j=parseFloat(b.attr("ry"))||0,k=a.rect(e,f,g,h);if(i||j){var l=e+g,m=f+h;c=["M",e+i,f,"L",l-i,f,"Q",l,f,l,f+j,"L",l,f+h-j,"Q",l,m,l-i,m,"L",e+i,m,"Q",e,m,e,m-i,"L",e,f+j,"Q",e,f,e+i,f,"Z"].join(" ")}else c=["M",k.origin().x,k.origin().y,"H",k.corner().x,"V",k.corner().y,"H",k.origin().x,"V",k.origin().y,"Z"].join(" ");return c}function p(a){var b=a.rx||a["top-rx"]||0,c=a.rx||a["bottom-rx"]||0,d=a.ry||a["top-ry"]||0,e=a.ry||a["bottom-ry"]||0;return["M",a.x,a.y+d,"v",a.height-d-e,"a",c,e,0,0,0,c,e,"h",a.width-2*c,"a",c,e,0,0,0,c,-e,"v",-(a.height-e-d),"a",b,d,0,0,0,-b,-d,"h",-(a.width-2*b),"a",b,d,0,0,0,-b,d].join(" ")}var q=(!(!window.SVGAngle&&!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")),{xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink"}),r="1.1",s=0;i.prototype={translate:function(a,b,c){c=c||{},b=b||0;var d=this.attr("transform")||"",e=f(d);if("undefined"==typeof a)return e.translate;d=d.replace(/translate\([^\)]*\)/g,"").trim();var g=c.absolute?a:e.translate.tx+a,h=c.absolute?b:e.translate.ty+b,i="translate("+g+","+h+")";return this.attr("transform",(i+" "+d).trim()),this},rotate:function(a,b,c,d){d=d||{};var e=this.attr("transform")||"",g=f(e);if("undefined"==typeof a)return g.rotate;e=e.replace(/rotate\([^\)]*\)/g,"").trim(),a%=360;var h=d.absolute?a:g.rotate.angle+a,i=void 0!==b&&void 0!==c?","+b+","+c:"",j="rotate("+h+i+")";return this.attr("transform",(e+" "+j).trim()),this},scale:function(a,b){b="undefined"==typeof b?a:b;var c=this.attr("transform")||"",d=f(c);if("undefined"==typeof a)return d.scale;c=c.replace(/scale\([^\)]*\)/g,"").trim();var e="scale("+a+","+b+")";return this.attr("transform",(c+" "+e).trim()),this},bbox:function(a,b){if(!this.node.ownerSVGElement)return{x:0,y:0,width:0,height:0};var c;try{c=this.node.getBBox(),c={x:0|c.x,y:0|c.y,width:0|c.width,height:0|c.height}}catch(d){c={x:this.node.clientLeft,y:this.node.clientTop,width:this.node.clientWidth,height:this.node.clientHeight}}if(a)return c;var e=this.node.getTransformToElement(b||this.node.ownerSVGElement);return u.transformRect(c,e)},text:function(a,b){b=b||{};var c,e=a.split("\n"),f=0;this.attr("y","0.8em"),this.attr("display",a?null:"none"),this.node.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:space","preserve"),this.node.textContent="";var g=this.node;if(b.textPath){var h=this.find("defs");0===h.length&&(h=d("defs"),this.append(h));var i=Object(b.textPath)===b.textPath?b.textPath.d:b.textPath;if(i){var j=d("path",{d:i});h.append(j)}var k=d("textPath");!b.textPath["xlink:href"]&&j&&k.attr("xlink:href","#"+j.node.id),Object(b.textPath)===b.textPath&&k.attr(b.textPath),this.append(k),g=k.node}if(1===e.length)return g.textContent=a,this;for(;f<e.length;f++)c=u("tspan",{dy:0==f?"0em":b.lineHeight||"1em",x:this.attr("x")||0}),c.addClass("v-line"),e[f]||c.addClass("v-empty-line"),c.node.textContent=e[f]||" ",u(g).append(c);return this},attr:function(a,b){if("undefined"==typeof a){for(var c=this.node.attributes,d={},f=0;f<c.length;f++)d[c[f].nodeName]=c[f].nodeValue;return d}if("string"==typeof a&&"undefined"==typeof b)return this.node.getAttribute(a);if("object"==typeof a)for(var g in a)a.hasOwnProperty(g)&&e(this.node,g,a[g]);else e(this.node,a,b);return this},remove:function(){this.node.parentNode&&this.node.parentNode.removeChild(this.node)},append:function(a){var b=a;"[object Array]"!==Object.prototype.toString.call(a)&&(b=[a]);for(var c=0,d=b.length;d>c;c++)a=b[c],this.node.appendChild(a instanceof i?a.node:a);return this},prepend:function(a){this.node.insertBefore(a instanceof i?a.node:a,this.node.firstChild)},svg:function(){return this.node instanceof window.SVGSVGElement?this:u(this.node.ownerSVGElement)},defs:function(){var a=this.svg().node.getElementsByTagName("defs");return a&&a.length?u(a[0]):void 0},clone:function(){var a=u(this.node.cloneNode(!0));return a.node.id=b(),a},findOne:function(a){var b=this.node.querySelector(a);return b?u(b):void 0},find:function(a){for(var b=this.node.querySelectorAll(a),c=0,d=b.length;d>c;c++)b[c]=u(b[c]);return b},toLocalPoint:function(a,b){var c=this.svg().node,d=c.createSVGPoint();d.x=a,d.y=b;try{var e=d.matrixTransform(c.getScreenCTM().inverse()),f=this.node.getTransformToElement(c).inverse()}catch(g){return d}return e.matrixTransform(f)},translateCenterToPoint:function(b){var c=this.bbox(),d=a.rect(c).center();this.translate(b.x-d.x,b.y-d.y)},translateAndAutoOrient:function(b,c,d){var e=this.scale();this.attr("transform",""),this.scale(e.sx,e.sy);var f=this.svg().node,g=this.bbox(!1,d),i=f.createSVGTransform();i.setTranslate(-g.x-g.width/2,-g.y-g.height/2);var j=f.createSVGTransform(),k=a.point(b).changeInAngle(b.x-c.x,b.y-c.y,c);j.setRotate(k,0,0);var l=f.createSVGTransform(),m=a.point(b).move(c,g.width/2);l.setTranslate(b.x+(b.x-m.x),b.y+(b.y-m.y));var n=this.node.getTransformToElement(d),o=f.createSVGTransform();o.setMatrix(l.matrix.multiply(j.matrix.multiply(i.matrix.multiply(n))));var p=h(o.matrix);return this.translate(p.translateX,p.translateY),this.rotate(p.rotation),this},animateAlongPath:function(a,b){var c=u("animateMotion",a),d=u("mpath",{"xlink:href":"#"+u(b).node.id});c.append(d),this.append(c);try{c.node.beginElement()}catch(e){if("fake"===document.documentElement.getAttribute("smiling")){var f=c.node;f.animators=[];var g=f.getAttribute("id");g&&(id2anim[g]=f);for(var h=getTargets(f),i=0,j=h.length;j>i;i++){var k=h[i],l=new Animator(f,k,i);animators.push(l),f.animators[i]=l,l.register()}}}},hasClass:function(a){return new RegExp("(\\s|^)"+a+"(\\s|$)").test(this.node.getAttribute("class"))},addClass:function(a){if(!this.hasClass(a)){var b=this.node.getAttribute("class")||"";this.node.setAttribute("class",(b+" "+a).trim())}return this},removeClass:function(a){if(this.hasClass(a)){var b=this.node.getAttribute("class").replace(new RegExp("(\\s|^)"+a+"(\\s|$)","g"),"$2");this.node.setAttribute("class",b)}return this},toggleClass:function(a,b){var c="undefined"==typeof b?this.hasClass(a):!b;return c?this.removeClass(a):this.addClass(a),this},sample:function(a){a=a||1;for(var b,c=this.node,d=c.getTotalLength(),e=[],f=0;d>f;)b=c.getPointAtLength(f),e.push({x:b.x,y:b.y,distance:f}),f+=a;return e},convertToPath:function(){var a=d("path");a.attr(this.attr());var b=this.convertToPathData();return b&&a.attr("d",b),a},convertToPathData:function(){var a=this.node.tagName.toUpperCase();switch(a){case"PATH":return this.attr("d");case"LINE":return j(this.node);case"POLYGON":return k(this.node);case"POLYLINE":return l(this.node);case"ELLIPSE":return n(this.node);case"CIRCLE":return m(this.node);case"RECT":return o(this.node)}throw new Error(a+" cannot be converted to PATH.")},findIntersection:function(b,c){var d=this.svg().node;c=c||d;var e=a.rect(this.bbox(!1,c)),f=e.center(),g=e.intersectionWithLineFromCenterToPoint(b);if(!g)return void 0;var h=this.node.localName.toUpperCase();if("RECT"===h){var i=a.rect(parseFloat(this.attr("x")||0),parseFloat(this.attr("y")||0),parseFloat(this.attr("width")),parseFloat(this.attr("height"))),j=this.node.getTransformToElement(c),k=u.decomposeMatrix(j),l=d.createSVGTransform();l.setRotate(-k.rotation,f.x,f.y);var m=u.transformRect(i,l.matrix.multiply(j));g=a.rect(m).intersectionWithLineFromCenterToPoint(b,k.rotation)}else if("PATH"===h||"POLYGON"===h||"POLYLINE"===h||"CIRCLE"===h||"ELLIPSE"===h){for(var n="PATH"===h?this:this.convertToPath(),o=n.sample(),p=1/0,q=[],r=0,s=o.length;s>r;r++){var t=o[r],v=u.createSVGPoint(t.x,t.y);v=v.matrixTransform(this.node.getTransformToElement(c)),t=a.point(v);var w=t.distance(f),x=1.1*t.distance(b),y=w+x;p>y?(p=y,q=[{sample:t,refDistance:x}]):p+1>y&&q.push({sample:t,refDistance:x})}q.sort(function(a,b){return a.refDistance-b.refDistance}),g=q[0].sample}return g}};var t=.5522847498307935,u=d;u.decomposeMatrix=h,u.rectToPath=p;var v=u("svg").node;return u.createSVGMatrix=function(a){var b=v.createSVGMatrix();for(var c in a)b[c]=a[c];return b},u.createSVGTransform=function(){return v.createSVGTransform()},u.createSVGPoint=function(a,b){var c=v.createSVGPoint();return c.x=a,c.y=b,c},u.transformRect=function(a,b){var c=v.createSVGPoint();c.x=a.x,c.y=a.y;var d=c.matrixTransform(b);c.x=a.x+a.width,c.y=a.y;var e=c.matrixTransform(b);c.x=a.x+a.width,c.y=a.y+a.height;var f=c.matrixTransform(b);c.x=a.x,c.y=a.y+a.height;var g=c.matrixTransform(b),h=Math.min(d.x,e.x,f.x,g.x),i=Math.max(d.x,e.x,f.x,g.x),j=Math.min(d.y,e.y,f.y,g.y),k=Math.max(d.y,e.y,f.y,g.y);return{x:h,y:j,width:i-h,height:k-j}},u}),function(a,b){if("function"==typeof define&&define.amd)define(["lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("$")||require("jQuery"),d=require("Backbone"),e=require("lodash"),f=require("V")||require("Vectorizer"),g=require("G")||require("Geometry")||require("g");exports.joint=b(e,d,f,g,c)}else{var c=a.$||a.jQuery,d=a.Backbone,e=a._,f=a.V||a.Vectorizer,g=a.G||a.Geometry||a.g;a.joint=b(e,d,f,g,c)}}(this,function(a,b,c,d,e){var f={version:"0.9.3",dia:{},ui:{},layout:{},shapes:{},format:{},connectors:{},routers:{},util:{hashCode:function(a){var b=0;if(0==a.length)return b;for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);b=(b<<5)-b+d,b&=b}return b},getByPath:function(a,b,c){c=c||".";for(var d,e=b.split(c);e.length;){if(d=e.shift(),!(Object(a)===a&&d in a))return void 0;a=a[d]}return a},setByPath:function(a,b,c,d){d=d||".";var e=b.split(d),f=a,g=0;if(b.indexOf(d)>-1){for(var h=e.length;h-1>g;g++)f=f[e[g]]||(f[e[g]]={});f[e[h-1]]=c}else a[b]=c;return a},unsetByPath:function(a,b,c){c=c||".";var d=b.lastIndexOf(c);if(d>-1){var e=f.util.getByPath(a,b.substr(0,d),c);e&&delete e[b.slice(d+1)]}else delete a[b];return a},flattenObject:function(a,b,c){b=b||".";var d={};for(var e in a)if(a.hasOwnProperty(e)){var f="object"==typeof a[e];if(f&&c&&c(a[e])&&(f=!1),f){var g=this.flattenObject(a[e],b,c);for(var h in g)g.hasOwnProperty(h)&&(d[e+b+h]=g[h])}else d[e]=a[e]}return d},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},guid:function(a){return this.guid.id=this.guid.id||1,a.id=void 0===a.id?"j_"+this.guid.id++:a.id,a.id},mixin:function(){for(var b=arguments[0],c=1,d=arguments.length;d>c;c++){var e=arguments[c];(Object(e)===e||a.isFunction(e)||null!==e&&void 0!==e)&&a.each(e,function(c,d){return this.mixin.deep&&Object(c)===c?(b[d]||(b[d]=a.isArray(c)?[]:{}),void this.mixin(b[d],c)):void(b[d]!==c&&(this.mixin.supplement&&b.hasOwnProperty(d)||(b[d]=c)))},this)}return b},supplement:function(){this.mixin.supplement=!0;var a=this.mixin.apply(this,arguments);return this.mixin.supplement=!1,a},deepMixin:function(){this.mixin.deep=!0;var a=this.mixin.apply(this,arguments);return this.mixin.deep=!1,a},deepSupplement:function(){this.mixin.deep=this.mixin.supplement=!0;var a=this.mixin.apply(this,arguments);return this.mixin.deep=this.mixin.supplement=!1,a},normalizeEvent:function(a){return a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?a.originalEvent.changedTouches[0]:a},nextFrame:function(){var b,c="undefined"!=typeof window;if(c&&(b=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame),!b){var d=0;b=function(a){var b=(new Date).getTime(),c=Math.max(0,16-(b-d)),e=setTimeout(function(){a(b+c)},c);return d=b+c,e}}return c?a.bind(b,window):b}(),cancelFrame:function(){var b,c="undefined"!=typeof window;return c&&(b=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame),b=b||clearTimeout,c?a.bind(b,window):b}(),findIntersection:function(b,e){var f=d.rect(c(b).bbox()).moveAndExpand(d.rect(-5,-5,10,10)),g=f.center(),h=d.rect(f).intersectionWithLineFromCenterToPoint(e);if(!h)return void 0;if(!a.contains(["PATH","CIRCLE","ELLIPSE","RECT","POLYGON","LINE","POLYLINE"],b.localName.toUpperCase()))return h;if(!b.isPointInStroke||!b.isPointInFill)return h;for(var i=h,j=b.getCTM(),k=c.createSVGPoint(0,0),l=h.distance(g);l>1;){if(h=h.move(g,-1),l=h.distance(g),k.x=h.x,k.y=h.y,k=k.matrixTransform(j.inverse()),b.isPointInStroke(k)||b.isPointInFill(k))return i;i=d.point(h)}return void 0},shapePerimeterConnectionPoint:function(a,b,c,e){var g,h=d.rect(b.getBBox());if(!c){var i=b.$(".scalable")[0],j=b.$(".rotatable")[0];i&&i.firstChild?c=i.firstChild:j&&j.firstChild&&(c=j.firstChild)}return g=c?f.util.findIntersection(c,e):h.intersectionWithLineFromCenterToPoint(e),g||h.center()},breakText:function(a,b,d,e){e=e||{};var f=b.width,g=b.height,h=e.svgDocument||c("svg").node,i=c("<text><tspan></tspan></text>").attr(d||{}).node,j=i.firstChild,k=document.createTextNode("");j.appendChild(k),h.appendChild(i),e.svgDocument||document.body.appendChild(h);for(var l,m=a.split(" "),n=[],o=[],p=0,q=0,r=m.length;r>p;p++){var s=m[p];if(k.data=o[q]?o[q]+" "+s:s,j.getComputedTextLength()<=f)o[q]=k.data,l&&(n[q++]=!0,l=0);else{if(!o[q]||l){var t=!!l;if(l=s.length-1,t||!l){if(!l){if(!o[q]){o=[];break}m.splice(p,2,s+m[p+1]),r--,n[q++]=!0,p--;continue}m[p]=s.substring(0,l),m[p+1]=s.substring(l)+m[p+1]}else m.splice(p,1,s.substring(0,l),s.substring(l)),r++,q&&!n[q-1]&&q--;p--;continue}q++,p--}if("undefined"!=typeof g){var u=u||1.25*i.getBBox().height;if(u*o.length>g){o.splice(Math.floor(g/u));break}}}return e.svgDocument?h.removeChild(i):document.body.removeChild(h),o.join("\n")},imageToDataUri:function(a,b){if(!a||"data:"===a.substr(0,"data:".length))return setTimeout(function(){b(null,a)},0);var c=document.createElement("canvas"),d=document.createElement("img");d.onload=function(){var e=c.getContext("2d");c.width=d.width,c.height=d.height,e.drawImage(d,0,0);try{var f=(a.split(".").pop()||"png","jpeg"),g=c.toDataURL(f)}catch(h){if(/\.svg$/.test(a)){var i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.open("GET",a,!1),i.send(null);var j=i.responseText;return b(null,"data:image/svg+xml,"+encodeURIComponent(j))}console.error(d.src,"fails to convert",h)}b(null,g)},d.ononerror=function(){b(new Error("Failed to load image."))},d.src=a},timing:{linear:function(a){return a},quad:function(a){return a*a},cubic:function(a){return a*a*a},inout:function(a){if(0>=a)return 0;if(a>=1)return 1;var b=a*a,c=b*a;return 4*(.5>a?c:3*(a-b)+c-.75)},exponential:function(a){return Math.pow(2,10*(a-1))},bounce:function(a){for(var b=0,c=1;1;b+=c,c/=2)if(a>=(7-4*b)/11){var d=(11-6*b-11*a)/4;return-d*d+c*c}},reverse:function(a){return function(b){return 1-a(1-b)}},reflect:function(a){return function(b){return.5*(.5>b?a(2*b):2-a(2-2*b))}},clamp:function(a,b,c){return b=b||0,c=c||1,function(d){var e=a(d);return b>e?b:e>c?c:e}},back:function(a){return a||(a=1.70158),function(b){return b*b*((a+1)*b-a)}},elastic:function(a){return a||(a=1.5),function(b){return Math.pow(2,10*(b-1))*Math.cos(20*Math.PI*a/3*b)}}},interpolate:{number:function(a,b){var c=b-a;return function(b){return a+c*b}},object:function(b,c){var d=a.keys(b);return function(a){var e,f,g={};for(e=d.length-1;-1!=e;e--)f=d[e],g[f]=b[f]+(c[f]-b[f])*a;return g}},hexColor:function(a,b){var c=parseInt(a.slice(1),16),d=parseInt(b.slice(1),16),e=255&c,f=(255&d)-e,g=65280&c,h=(65280&d)-g,i=16711680&c,j=(16711680&d)-i;return function(a){var b=e+f*a&255,c=g+h*a&65280,d=i+j*a&16711680;return"#"+(1<<24|b|c|d).toString(16).slice(1)}},unit:function(a,b){var c=/(-?[0-9]*.[0-9]*)(px|em|cm|mm|in|pt|pc|%)/,d=c.exec(a),e=c.exec(b),f=e[1].indexOf("."),g=f>0?e[1].length-f-1:0,a=+d[1],h=+e[1]-a,i=d[2];return function(b){return(a+h*b).toFixed(g)+i}}},filter:{blur:function(b){var c=a.isFinite(b.x)?b.x:2;return a.template('<filter><feGaussianBlur stdDeviation="${stdDeviation}"/></filter>',{stdDeviation:a.isFinite(b.y)?[c,b.y]:c})},dropShadow:function(b){var c="SVGFEDropShadowElement"in window?'<filter><feDropShadow stdDeviation="${blur}" dx="${dx}" dy="${dy}" flood-color="${color}" flood-opacity="${opacity}"/></filter>':'<filter><feGaussianBlur in="SourceAlpha" stdDeviation="${blur}"/><feOffset dx="${dx}" dy="${dy}" result="offsetblur"/><feFlood flood-color="${color}"/><feComposite in2="offsetblur" operator="in"/><feComponentTransfer><feFuncA type="linear" slope="${opacity}"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>';return a.template(c,{dx:b.dx||0,dy:b.dy||0,opacity:a.isFinite(b.opacity)?b.opacity:1,color:b.color||"black",blur:a.isFinite(b.blur)?b.blur:4})},grayscale:function(b){var c=a.isFinite(b.amount)?b.amount:1;return a.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${b} ${h} 0 0 0 0 0 1 0"/></filter>',{a:.2126+.7874*(1-c),b:.7152-.7152*(1-c),c:.0722-.0722*(1-c),d:.2126-.2126*(1-c),e:.7152+.2848*(1-c),f:.0722-.0722*(1-c),g:.2126-.2126*(1-c),h:.0722+.9278*(1-c)})},sepia:function(b){var c=a.isFinite(b.amount)?b.amount:1;return a.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${h} ${i} 0 0 0 0 0 1 0"/></filter>',{a:.393+.607*(1-c),b:.769-.769*(1-c),c:.189-.189*(1-c),d:.349-.349*(1-c),e:.686+.314*(1-c),f:.168-.168*(1-c),g:.272-.272*(1-c),h:.534-.534*(1-c),i:.131+.869*(1-c)})},saturate:function(b){var c=a.isFinite(b.amount)?b.amount:1;return a.template('<filter><feColorMatrix type="saturate" values="${amount}"/></filter>',{amount:1-c})},hueRotate:function(b){return a.template('<filter><feColorMatrix type="hueRotate" values="${angle}"/></filter>',{angle:b.angle||0})},invert:function(b){var c=a.isFinite(b.amount)?b.amount:1;return a.template('<filter><feComponentTransfer><feFuncR type="table" tableValues="${amount} ${amount2}"/><feFuncG type="table" tableValues="${amount} ${amount2}"/><feFuncB type="table" tableValues="${amount} ${amount2}"/></feComponentTransfer></filter>',{amount:c,amount2:1-c})},brightness:function(b){return a.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}"/><feFuncG type="linear" slope="${amount}"/><feFuncB type="linear" slope="${amount}"/></feComponentTransfer></filter>',{amount:a.isFinite(b.amount)?b.amount:1})},contrast:function(b){var c=a.isFinite(b.amount)?b.amount:1;return a.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}" intercept="${amount2}"/><feFuncG type="linear" slope="${amount}" intercept="${amount2}"/><feFuncB type="linear" slope="${amount}" intercept="${amount2}"/></feComponentTransfer></filter>',{amount:c,amount2:.5-c/2})}},format:{number:function(a,b,c){function d(a){for(var b=a.length,d=[],e=0,f=c.grouping[0];b>0&&f>0;)d.push(a.substring(b-=f,b+f)),f=c.grouping[e=(e+1)%c.grouping.length];return d.reverse().join(c.thousands)}c=c||{currency:["$",""],decimal:".",thousands:",",grouping:[3]};var e=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,f=e.exec(a),g=f[1]||" ",h=f[2]||">",i=f[3]||"",j=f[4]||"",k=f[5],l=+f[6],m=f[7],n=f[8],o=f[9],p=1,q="",r="",s=!1;switch(n&&(n=+n.substring(1)),(k||"0"===g&&"="===h)&&(k=g="0",h="=",m&&(l-=Math.floor((l-1)/4))),o){case"n":m=!0,o="g";break;case"%":p=100,r="%",o="f";break;case"p":p=100,r="%",o="r";break;case"b":case"o":case"x":case"X":"#"===j&&(q="0"+o.toLowerCase());case"c":case"d":s=!0,n=0;break;case"s":p=-1,o="r"}"$"===j&&(q=c.currency[0],r=c.currency[1]),"r"!=o||n||(o="g"),null!=n&&("g"==o?n=Math.max(1,Math.min(21,n)):("e"==o||"f"==o)&&(n=Math.max(0,Math.min(20,n))));var t=k&&m;if(s&&b%1)return"";var u=0>b||0===b&&0>1/b?(b=-b,"-"):i,v=r;if(0>p){var w=this.prefix(b,n);b=w.scale(b),v=w.symbol+r}else b*=p;b=this.convert(o,b,n);var x=b.lastIndexOf("."),y=0>x?b:b.substring(0,x),z=0>x?"":c.decimal+b.substring(x+1);!k&&m&&c.grouping&&(y=d(y));var A=q.length+y.length+z.length+(t?0:u.length),B=l>A?new Array(A=l-A+1).join(g):"";

return t&&(y=d(B+y)),u+=q,b=y+z,("<"===h?u+b+B:">"===h?B+u+b:"^"===h?B.substring(0,A>>=1)+u+b+B.substring(A):u+(t?b:B+b))+v},string:function(a,b){for(var c,d="{",e=!1,f=[];-1!==(c=a.indexOf(d));){var g,h,i;if(g=a.slice(0,c),e){h=g.split(":"),i=h.shift().split("."),g=b;for(var j=0;j<i.length;j++)g=g[i[j]];h.length&&(g=this.number(h,g))}f.push(g),a=a.slice(c+1),d=(e=!e)?"}":"{"}return f.push(a),f.join("")},convert:function(a,b,c){switch(a){case"b":return b.toString(2);case"c":return String.fromCharCode(b);case"o":return b.toString(8);case"x":return b.toString(16);case"X":return b.toString(16).toUpperCase();case"g":return b.toPrecision(c);case"e":return b.toExponential(c);case"f":return b.toFixed(c);case"r":return(b=this.round(b,this.precision(b,c))).toFixed(Math.max(0,Math.min(20,this.precision(b*(1+1e-15),c))));default:return b+""}},round:function(a,b){return b?Math.round(a*(b=Math.pow(10,b)))/b:Math.round(a)},precision:function(a,b){return b-(a?Math.ceil(Math.log(a)/Math.LN10):1)},prefix:function(b,c){var d=a.map(["y","z","a","f","p","n","Âµ","m","","k","M","G","T","P","E","Z","Y"],function(a,b){var c=Math.pow(10,3*abs(8-b));return{scale:b>8?function(a){return a/c}:function(a){return a*c},symbol:a}}),e=0;return b&&(0>b&&(b*=-1),c&&(b=this.round(b,this.precision(b,c))),e=1+Math.floor(1e-12+Math.log(b)/Math.LN10),e=Math.max(-24,Math.min(24,3*Math.floor((0>=e?e+1:e-1)/3)))),d[8+e/3]}}}};return f}),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.dia.GraphCells=c.Collection.extend({initialize:function(){this.on("change:z",this.sort,this)},model:function(b,c){if("link"===b.type)return new a.dia.Link(b,c);var d=b.type.split(".")[0],e=b.type.split(".")[1];return a.shapes[d]&&a.shapes[d][e]?new a.shapes[d][e](b,c):new a.dia.Element(b,c)},comparator:function(a){return a.get("z")||0},getConnectedLinks:function(a,c){c=c||{},b.isUndefined(c.inbound)&&b.isUndefined(c.outbound)&&(c.inbound=c.outbound=!0);var d=this.filter(function(b){var d=b.get("source"),e=b.get("target");return d&&d.id===a.id&&c.outbound||e&&e.id===a.id&&c.inbound});if(c.deep){var e=a.getEmbeddedCells({deep:!0});b.each(this.difference(d,e),function(a){if(c.outbound){var f=a.get("source");if(f&&f.id&&b.find(e,{id:f.id}))return void d.push(a)}if(c.inbound){var g=a.get("target");g&&g.id&&b.find(e,{id:g.id})&&d.push(a)}})}return d},getCommonAncestor:function(){var a=b.map(arguments,function(a){for(var b=[a.id],c=a.get("parent");c;)b.push(c),c=this.get(c).get("parent");return b},this);a=b.sortBy(a,"length");var c=b.find(a.shift(),function(c){return b.every(a,function(a){return b.contains(a,c)})});return this.get(c)}}),a.dia.Graph=c.Model.extend({initialize:function(b,c){this.set("cells",new a.dia.GraphCells([],{model:c&&c.cellModel})),this.get("cells").on("all",this.trigger,this),this.get("cells").on("remove",this.removeCell,this)},toJSON:function(){var a=c.Model.prototype.toJSON.apply(this,arguments);return a.cells=this.get("cells").toJSON(),a},fromJSON:function(a,c){if(!a.cells)throw new Error("Graph JSON must contain cells array.");this.set(b.omit(a,"cells"),c),this.resetCells(a.cells,c)},clear:function(a){this.trigger("batch:start"),this.get("cells").remove(this.get("cells").models,a),this.trigger("batch:stop")},_prepareCell:function(a){return a instanceof c.Model&&b.isUndefined(a.get("z"))?a.set("z",this.maxZIndex()+1,{silent:!0}):b.isUndefined(a.z)&&(a.z=this.maxZIndex()+1),a},maxZIndex:function(){var a=this.get("cells").last();return a?a.get("z")||0:0},addCell:function(a,c){return b.isArray(a)?this.addCells(a,c):(this.get("cells").add(this._prepareCell(a),c||{}),this)},addCells:function(a,c){return c=c||{},c.position=a.length,b.each(a,function(a){c.position--,this.addCell(a,c)},this),this},resetCells:function(a,c){return this.get("cells").reset(b.map(a,this._prepareCell,this),c),this},removeCell:function(a,b,c){c&&c.disconnectLinks?this.disconnectLinks(a,c):this.removeLinks(a,c),this.get("cells").remove(a,{silent:!0})},getCell:function(a){return this.get("cells").get(a)},getElements:function(){return this.get("cells").filter(function(b){return b instanceof a.dia.Element})},getLinks:function(){return this.get("cells").filter(function(b){return b instanceof a.dia.Link})},getConnectedLinks:function(a,b){return this.get("cells").getConnectedLinks(a,b)},getNeighbors:function(a){var c=this.getConnectedLinks(a),d=[],e=this.get("cells");return b.each(c,function(b){var c=b.get("source"),f=b.get("target");if(!c.x){var g=e.get(c.id);g!==a&&d.push(g)}if(!f.x){var h=e.get(f.id);h!==a&&d.push(h)}}),d},disconnectLinks:function(a,c){b.each(this.getConnectedLinks(a),function(b){b.set(b.get("source").id===a.id?"source":"target",e.point(0,0),c)})},removeLinks:function(a,c){b.invoke(this.getConnectedLinks(a),"remove",c)},findModelsFromPoint:function(a){return b.filter(this.getElements(),function(b){return b.getBBox().containsPoint(a)})},findModelsInArea:function(a){return b.filter(this.getElements(),function(b){return b.getBBox().intersect(a)})},getBBox:function(a){var c={x:1/0,y:1/0},d={x:0,y:0};return b.each(a,function(a){var b=a.getBBox();c.x=Math.min(c.x,b.x),c.y=Math.min(c.y,b.y),d.x=Math.max(d.x,b.x+b.width),d.y=Math.max(d.y,b.y+b.height)}),e.rect(c.x,c.y,d.x-c.x,d.y-c.y)},getCommonAncestor:function(){var a=this.get("cells");return a.getCommonAncestor.apply(a,arguments)}})}),"object"==typeof exports&&(module.exports.Graph=joint.dia.Graph),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.dia.Cell=c.Model.extend({constructor:function(a,c){var d,e=a||{};this.cid=b.uniqueId("c"),this.attributes={},c&&c.collection&&(this.collection=c.collection),c&&c.parse&&(e=this.parse(e,c)||{}),(d=b.result(this,"defaults"))&&(e=b.merge({},d,e)),this.set(e,c),this.changed={},this.initialize.apply(this,arguments)},toJSON:function(){var a=this.constructor.prototype.defaults.attrs||{},c=this.attributes.attrs,d={};b.each(c,function(c,e){var f=a[e];b.each(c,function(a,c){b.isObject(a)&&!b.isArray(a)?b.each(a,function(a,g){f&&f[c]&&b.isEqual(f[c][g],a)||(d[e]=d[e]||{},(d[e][c]||(d[e][c]={}))[g]=a)}):f&&b.isEqual(f[c],a)||(d[e]=d[e]||{},d[e][c]=a)})});var e=b.cloneDeep(b.omit(this.attributes,"attrs"));return e.attrs=d,e},initialize:function(b){b&&b.id||this.set("id",a.util.uuid(),{silent:!0}),this._transitionIds={},this.processPorts(),this.on("change:attrs",this.processPorts,this)},processPorts:function(){var a=this.ports,c={};b.each(this.get("attrs"),function(a,d){a&&a.port&&(b.isUndefined(a.port.id)?c[a.port]={id:a.port}:c[a.port.id]=a.port)});var d={};if(b.each(a,function(a,b){c[b]||(d[b]=!0)}),this.collection&&!b.isEmpty(d)){var e=this.collection.getConnectedLinks(this,{inbound:!0});b.each(e,function(a){d[a.get("target").port]&&a.remove()});var f=this.collection.getConnectedLinks(this,{outbound:!0});b.each(f,function(a){d[a.get("source").port]&&a.remove()})}this.ports=c},remove:function(a){var c=this.collection;c&&c.trigger("batch:start");var d=this.get("parent");if(d){var e=this.collection&&this.collection.get(d);e.unembed(this)}return b.invoke(this.getEmbeddedCells(),"remove",a),this.trigger("remove",this,this.collection,a),c&&c.trigger("batch:stop"),this},toFront:function(a){if(this.collection){a=a||{};var c=(this.collection.last().get("z")||0)+1;if(this.trigger("batch:start").set("z",c,a),a.deep){var d=this.getEmbeddedCells({deep:!0,breadthFirst:!0});b.each(d,function(b){b.set("z",++c,a)})}this.trigger("batch:stop")}return this},toBack:function(a){if(this.collection){a=a||{};var c=(this.collection.first().get("z")||0)-1;if(this.trigger("batch:start"),a.deep){var d=this.getEmbeddedCells({deep:!0,breadthFirst:!0});b.eachRight(d,function(b){b.set("z",c--,a)})}this.set("z",c,a).trigger("batch:stop")}return this},embed:function(a,c){if(this==a||this.isEmbeddedIn(a))throw new Error("Recursive embedding not allowed.");this.trigger("batch:start");var d=b.clone(this.get("embeds")||[]);return d[a.isLink()?"unshift":"push"](a.id),a.set("parent",this.id,c),this.set("embeds",b.uniq(d),c),this.trigger("batch:stop"),this},unembed:function(a,c){return this.trigger("batch:start"),a.unset("parent",c),this.set("embeds",b.without(this.get("embeds"),a.id),c),this.trigger("batch:stop"),this},getEmbeddedCells:function(a){if(a=a||{},this.collection){var c;if(a.deep)if(a.breadthFirst){c=[];for(var d=this.getEmbeddedCells();d.length>0;){var e=d.shift();c.push(e),d.push.apply(d,e.getEmbeddedCells())}}else c=this.getEmbeddedCells(),b.each(c,function(b){c.push.apply(c,b.getEmbeddedCells(a))});else c=b.map(this.get("embeds"),this.collection.get,this.collection);return c}return[]},isEmbeddedIn:function(a,c){var d=b.isString(a)?a:a.id;c=b.defaults({deep:!0},c);var e=this.get("parent");if(this.collection&&c.deep){for(;e;){if(e==d)return!0;e=this.collection.get(e).get("parent")}return!1}return e==d},clone:function(d){d=d||{};var e=c.Model.prototype.clone.apply(this,arguments);if(e.set("id",a.util.uuid(),{silent:!0}),e.set("embeds",""),!d.deep)return e;var f=b.sortBy(this.getEmbeddedCells(),function(b){return b instanceof a.dia.Element}),g=[e],h={};return b.each(f,function(c){var d=c.clone({deep:!0});e.embed(d[0]),b.each(d,function(d){if(d instanceof a.dia.Link)return d.get("source").id==this.id&&d.prop("source",{id:e.id}),d.get("target").id==this.id&&d.prop("target",{id:e.id}),void(h[c.id]=d);g.push(d);var f=this.collection.getConnectedLinks(c,{inbound:!0});b.each(f,function(a){var b=h[a.id]||a.clone();h[a.id]=b,b.prop("target",{id:d.id})});var i=this.collection.getConnectedLinks(c,{outbound:!0});b.each(i,function(a){var b=h[a.id]||a.clone();h[a.id]=b,b.prop("source",{id:d.id})})},this)},this),g=g.concat(b.values(h))},prop:function(c,d,e){var f="/";if(b.isString(c)){if("undefined"!=typeof d){var g=c,h=g.split("/"),i=h[0];if(e=e||{},e.propertyPath=g,e.propertyValue=d,1==h.length)return this.set(i,d,e);var j={},k=j,l=i;b.each(b.rest(h),function(a){k=k[l]=b.isFinite(Number(a))?[]:{},l=a}),j=a.util.setByPath(j,g,d,"/");var m=b.merge({},this.attributes);e.rewrite&&a.util.unsetByPath(m,g,"/");var n=b.merge(m,j);return this.set(i,n[i],e)}return a.util.getByPath(this.attributes,c,f)}return this.set(b.merge({},this.attributes,c),d)},attr:function(a,c,d){return b.isString(a)?this.prop("attrs/"+a,c,d):this.prop({attrs:a},c)},removeAttr:function(c,d){if(b.isArray(c))return b.each(c,function(a){this.removeAttr(a,d)},this),this;var e=a.util.unsetByPath(b.merge({},this.get("attrs")),c,"/");return this.set("attrs",e,b.extend({dirty:!0},d))},transition:function(c,d,e,f){f=f||"/";var g={duration:100,delay:10,timingFunction:a.util.timing.linear,valueFunction:a.util.interpolate.number};e=b.extend(g,e);var h,i=0,j=b.bind(function(b){var d,f,g;i=i||b,b-=i,f=b/e.duration,1>f?this._transitionIds[c]=d=a.util.nextFrame(j):(f=1,delete this._transitionIds[c]),g=h(e.timingFunction(f)),e.transitionId=d,this.prop(c,g,e),d||this.trigger("transition:end",this,c)},this),k=b.bind(function(b){this.stopTransitions(c),h=e.valueFunction(a.util.getByPath(this.attributes,c,f),d),this._transitionIds[c]=a.util.nextFrame(b),this.trigger("transition:start",this,c)},this);return b.delay(k,e.delay,j)},getTransitions:function(){return b.keys(this._transitionIds)},stopTransitions:function(c,d){d=d||"/";var e=c&&c.split(d);return b(this._transitionIds).keys().filter(e&&function(a){return b.isEqual(e,a.split(d).slice(0,e.length))}).each(function(b){a.util.cancelFrame(this._transitionIds[b]),delete this._transitionIds[b],this.trigger("transition:end",this,b)},this),this},addTo:function(a){return a.addCell(this),this},findView:function(a){return a.findViewByModel(this)},isLink:function(){return!1}}),a.dia.CellView=c.View.extend({tagName:"g",attributes:function(){return{"model-id":this.model.id}},constructor:function(a){this._configure(a),c.View.apply(this,arguments)},_configure:function(c){this.options&&(c=b.extend({},b.result(this,"options"),c)),this.options=c,this.options.id=this.options.id||a.util.guid(this)},initialize:function(){b.bindAll(this,"remove","update"),this.$el.data("view",this),this.listenTo(this.model,"remove",this.remove),this.listenTo(this.model,"change:attrs",this.onChangeAttrs)},onChangeAttrs:function(a,b,c){return c.dirty?this.render():this.update()},_ensureElement:function(){var a;if(this.el)a=b.result(this,"el");else{var c=b.extend({id:this.id},b.result(this,"attributes"));this.className&&(c["class"]=b.result(this,"className")),a=d(b.result(this,"tagName"),c).node}this.setElement(a,!1)},findBySelector:function(a){var b="."===a?this.$el:this.$el.find(a);return b},notify:function(a){if(this.paper){var b=Array.prototype.slice.call(arguments,1);this.trigger.apply(this,[a].concat(b)),this.paper.trigger.apply(this.paper,[a,this].concat(b))}},getStrokeBBox:function(a){var b=!!a;a=a||this.el;var c,f=d(a).bbox(!1,this.paper.viewport);return c=b?d(a).attr("stroke-width"):this.model.attr("rect/stroke-width")||this.model.attr("circle/stroke-width")||this.model.attr("ellipse/stroke-width")||this.model.attr("path/stroke-width"),c=parseFloat(c)||0,e.rect(f).moveAndExpand({x:-c/2,y:-c/2,width:c,height:c})},getBBox:function(){return d(this.el).bbox()},highlight:function(a,b){return a=a?this.$(a)[0]||this.el:this.el,b=b||{},b.partial=a!=this.el,this.notify("cell:highlight",a,b),this},unhighlight:function(a,b){return a=a?this.$(a)[0]||this.el:this.el,b=b||{},b.partial=a!=this.el,this.notify("cell:unhighlight",a,b),this},findMagnet:function(a){var b=this.$(a);if(0===b.length||b[0]===this.el){var c=this.model.get("attrs")||{};return c["."]&&c["."].magnet===!1?void 0:this.el}return b.attr("magnet")?b[0]:this.findMagnet(b.parent())},applyFilter:function(b,c){var e=this.findBySelector(b),f=c.name+this.paper.svg.id+a.util.hashCode(JSON.stringify(c));if(!this.paper.svg.getElementById(f)){var g=a.util.filter[c.name]&&a.util.filter[c.name](c.args||{});if(!g)throw new Error("Non-existing filter "+c.name);var h=d(g);h.attr({filterUnits:"objectBoundingBox",x:-1,y:-1,width:3,height:3}),c.attrs&&h.attr(c.attrs),h.node.id=f,d(this.paper.svg).defs().append(h)}e.each(function(){d(this).attr("filter","url(#"+f+")")})},applyGradient:function(c,e,f){var g=this.findBySelector(c),h=f.type+this.paper.svg.id+a.util.hashCode(JSON.stringify(f));if(!this.paper.svg.getElementById(h)){var i=["<"+f.type+">",b.map(f.stops,function(a){return'<stop offset="'+a.offset+'" stop-color="'+a.color+'" stop-opacity="'+(b.isFinite(a.opacity)?a.opacity:1)+'" />'}).join(""),"</"+f.type+">"].join(""),j=d(i);f.attrs&&j.attr(f.attrs),j.node.id=h,d(this.paper.svg).defs().append(j)}g.each(function(){d(this).attr(e,"url(#"+h+")")})},getSelector:function(a,b){if(a===this.el)return b;var c=f(a).index();return b=a.tagName+":nth-child("+(c+1)+") "+(b||""),this.getSelector(f(a).parent()[0],b+" ")},pointerdblclick:function(a,b,c){this.notify("cell:pointerdblclick",a,b,c)},pointerclick:function(a,b,c){this.notify("cell:pointerclick",a,b,c)},pointerdown:function(a,b,c){this.model.collection&&(this.model.trigger("batch:start"),this._collection=this.model.collection),this.notify("cell:pointerdown",a,b,c)},pointermove:function(a,b,c){this.notify("cell:pointermove",a,b,c)},pointerup:function(a,b,c){this.notify("cell:pointerup",a,b,c),this._collection&&(this._collection.trigger("batch:stop"),delete this._collection)},mouseover:function(a){this.notify("cell:mouseover",a)},mouseout:function(a){this.notify("cell:mouseout",a)}})}),"object"==typeof exports&&(module.exports.Cell=joint.dia.Cell,module.exports.CellView=joint.dia.CellView),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.dia.Element=a.dia.Cell.extend({defaults:{position:{x:0,y:0},size:{width:1,height:1},angle:0},position:function(a,c,d){var f=b.isNumber(c);if(d=(f?d:a)||{},d.parentRelative){if(!this.collection)throw new Error("Element must be part of a collection.");var g=this.collection.get(this.get("parent")),h=g&&!g.isLink()?g.get("position"):{x:0,y:0}}if(f)return d.parentRelative&&(a+=h.x,c+=h.y),this.set("position",{x:a,y:c},d);var i=e.point(this.get("position"));return d.parentRelative?i.difference(h):i},translate:function(c,d,e){if(d=d||0,0===c&&0===d)return this;e=e||{},e.translateBy=e.translateBy||this.id,e.tx=c,e.ty=d;var f=this.get("position")||{x:0,y:0},g={x:f.x+c||0,y:f.y+d||0};return e.transition?(b.isObject(e.transition)||(e.transition={}),this.transition("position",g,b.extend({},e.transition,{valueFunction:a.util.interpolate.object}))):(this.set("position",g,e),b.invoke(this.getEmbeddedCells(),"translate",c,d,e)),this},resize:function(a,b){return this.trigger("batch:start"),this.set("size",{width:a,height:b}),this.trigger("batch:stop"),this},rotate:function(a,b,c){if(c){var d=this.getBBox().center(),e=this.get("size"),f=this.get("position");d.rotate(c,(this.get("angle")||0)-a);var g=d.x-e.width/2-f.x,h=d.y-e.height/2-f.y;this.trigger("batch:start"),this.translate(g,h),this.rotate(a,b),this.trigger("batch:stop")}else this.set("angle",b?a:((this.get("angle")||0)+a)%360);return this},getBBox:function(){var a=this.get("position"),b=this.get("size");return e.rect(a.x,a.y,b.width,b.height)}}),a.dia.ElementView=a.dia.CellView.extend({className:function(){return"element "+this.model.get("type").split(".").join(" ")},initialize:function(){b.bindAll(this,"translate","resize","rotate"),a.dia.CellView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:position",this.translate),this.listenTo(this.model,"change:size",this.resize),this.listenTo(this.model,"change:angle",this.rotate)},update:function(a,c){var e=this.model.get("attrs"),g=d(this.$(".rotatable")[0]);if(g){var h=g.attr("transform");g.attr("transform","")}var i=[];b.each(c||e,function(a,c){var e=this.findBySelector(c);if(0!==e.length){var g=["style","text","html","ref-x","ref-y","ref-dx","ref-dy","ref-width","ref-height","ref","x-alignment","y-alignment","port"];b.isObject(a.filter)&&(g.push("filter"),this.applyFilter(c,a.filter)),b.isObject(a.fill)&&(g.push("fill"),this.applyGradient(c,"fill",a.fill)),b.isObject(a.stroke)&&(g.push("stroke"),this.applyGradient(c,"stroke",a.stroke)),b.isUndefined(a.text)||(e.each(function(){d(this).text(a.text+"",{lineHeight:a.lineHeight,textPath:a.textPath})}),g.push("lineHeight","textPath"));var h=b.omit(a,g);e.each(function(){d(this).attr(h)}),a.port&&e.attr("port",b.isUndefined(a.port.id)?a.port:a.port.id),a.style&&e.css(a.style),b.isUndefined(a.html)||e.each(function(){f(this).html(a.html+"")}),b.isUndefined(a["ref-x"])&&b.isUndefined(a["ref-y"])&&b.isUndefined(a["ref-dx"])&&b.isUndefined(a["ref-dy"])&&b.isUndefined(a["x-alignment"])&&b.isUndefined(a["y-alignment"])&&b.isUndefined(a["ref-width"])&&b.isUndefined(a["ref-height"])||b.each(e,function(a,b,c){var d=f(a);d.selector=c.selector,i.push(d)})}},this);var j=this.el.getBBox();c=c||{},b.each(i,function(a){var d=c[a.selector],f=d?b.merge({},e[a.selector],d):e[a.selector];this.positionRelative(a,j,f)},this),g&&g.attr("transform",h||"")},positionRelative:function(a,c,e){function f(a){return b.isNumber(a)&&!b.isNaN(a)}var g=e.ref,h=parseFloat(e["ref-x"]),i=parseFloat(e["ref-y"]),j=parseFloat(e["ref-dx"]),k=parseFloat(e["ref-dy"]),l=e["y-alignment"],m=e["x-alignment"],n=parseFloat(e["ref-width"]),o=parseFloat(e["ref-height"]),p=b.contains(b.pluck(b.pluck(a.parents("g"),"className"),"baseVal"),"scalable");g&&(c=d(this.findBySelector(g)[0]).bbox(!1,this.el));var q=d(a[0]);q.attr("transform")&&q.attr("transform",q.attr("transform").replace(/translate\([^)]*\)/g,"").trim()||"");var r=0,s=0;if(f(n)&&(n>=0&&1>=n?q.attr("width",n*c.width):q.attr("width",Math.max(n+c.width,0))),f(o)&&(o>=0&&1>=o?q.attr("height",o*c.height):q.attr("height",Math.max(o+c.height,0))),f(j))if(p){var t=d(this.$(".scalable")[0]).scale();r=c.x+c.width+j/t.sx}else r=c.x+c.width+j;if(f(k))if(p){var t=d(this.$(".scalable")[0]).scale();s=c.y+c.height+k/t.sy}else s=c.y+c.height+k;if(f(h))if(h>0&&1>h)r=c.x+c.width*h;else if(p){var t=d(this.$(".scalable")[0]).scale();r=c.x+h/t.sx}else r=c.x+h;if(f(i))if(i>0&&1>i)s=c.y+c.height*i;else if(p){var t=d(this.$(".scalable")[0]).scale();s=c.y+i/t.sy}else s=c.y+i;var u=q.bbox(!1,this.paper.viewport);"middle"===l?s-=u.height/2:f(l)&&(s+=l>-1&&1>l?u.height*l:l),"middle"===m?r-=u.width/2:f(m)&&(r+=m>-1&&1>m?u.width*m:m),q.translate(r,s)},renderMarkup:function(){var a=this.model.markup||this.model.get("markup");if(!a)throw new Error("properties.markup is missing while the default render() implementation is used.");var b=d(a);d(this.el).append(b)},render:function(){return this.$el.empty(),this.renderMarkup(),this.update(),this.resize(),this.rotate(),this.translate(),this},scale:function(a,b){d(this.el).scale(a,b)},resize:function(){var a=this.model.get("size")||{width:1,height:1},b=this.model.get("angle")||0,c=d(this.$(".scalable")[0]);if(c){var e=c.bbox(!0);c.attr("transform","scale("+a.width/(e.width||1)+","+a.height/(e.height||1)+")");var f=d(this.$(".rotatable")[0]),g=f&&f.attr("transform");if(g&&"null"!==g){f.attr("transform",g+" rotate("+-b+","+a.width/2+","+a.height/2+")");var h=c.bbox(!1,this.paper.viewport);this.model.set("position",{x:h.x,y:h.y}),this.rotate()}this.update()}},translate:function(a,b,c){var e=this.model.get("position")||{x:0,y:0};d(this.el).attr("transform","translate("+e.x+","+e.y+")")},rotate:function(){var a=d(this.$(".rotatable")[0]);if(a){var b=this.model.get("angle")||0,c=this.model.get("size")||{width:1,height:1},e=c.width/2,f=c.height/2;a.attr("transform","rotate("+b+","+e+","+f+")")}},getBBox:function(b){if(b&&b.useModelGeometry){var c=this.model.getBBox().bbox(this.model.get("angle")),e=this.paper.viewport.getCTM();return d.transformRect(c,e)}return a.dia.CellView.prototype.getBBox.apply(this,arguments)},findParentsByKey:function(a){var b=this.model.getBBox();return"bbox"==a?this.paper.model.findModelsInArea(b):this.paper.model.findModelsFromPoint(b[a]())},prepareEmbedding:function(){this.model.toFront({deep:!0,ui:!0}),b.invoke(this.paper.model.getConnectedLinks(this.model,{deep:!0}),"toFront",{ui:!0});var a=this.model.get("parent");a&&this.paper.model.getCell(a).unembed(this.model,{ui:!0})},processEmbedding:function(a){a=a||this.paper.options;var c=this.findParentsByKey(a.findParentBy);c=b.reject(c,function(a){return this.model.id==a.id||a.isEmbeddedIn(this.model)},this),a.frontParentOnly&&(c=c.slice(-1));for(var d=null,e=this._candidateEmbedView,f=c.length-1;f>=0;f--){var g=c[f];if(e&&e.model.id==g.id){d=e;break}var h=g.findView(this.paper);if(a.validateEmbedding.call(this.paper,this,h)){d=h;break}}d&&d!=e&&(e&&e.unhighlight(null,{embedding:!0}),this._candidateEmbedView=d.highlight(null,{embedding:!0})),!d&&e&&(e.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView)},finalizeEmbedding:function(){var a=this._candidateEmbedView;a&&(a.model.embed(this.model,{ui:!0}),a.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView),b.invoke(this.paper.model.getConnectedLinks(this.model,{deep:!0}),"reparent",{ui:!0})},pointerdown:function(b,c,d){if(this.model.trigger("batch:start"),b.target.getAttribute("magnet")&&this.paper.options.validateMagnet.call(this.paper,this,b.target)){var e=this.paper.getDefaultLink(this,b.target);e.set({source:{id:this.model.id,selector:this.getSelector(b.target),port:f(b.target).attr("port")},target:{x:c,y:d}}),this.paper.model.addCell(e),this._linkView=this.paper.findViewByModel(e),this._linkView.startArrowheadMove("target")}else this._dx=c,this._dy=d,a.dia.CellView.prototype.pointerdown.apply(this,arguments)},pointermove:function(c,d,f){if(this._linkView)this._linkView.pointermove(c,d,f);else{var g=this.paper.options.gridSize,h=b.isFunction(this.options.interactive)?this.options.interactive(this,"pointermove"):this.options.interactive;if(h!==!1){var i=this.model.get("position");this.model.translate(e.snapToGrid(i.x,g)-i.x+e.snapToGrid(d-this._dx,g),e.snapToGrid(i.y,g)-i.y+e.snapToGrid(f-this._dy,g)),this.paper.options.embeddingMode&&(this._inProcessOfEmbedding||(this.prepareEmbedding(),this._inProcessOfEmbedding=!0),this.processEmbedding())}this._dx=e.snapToGrid(d,g),this._dy=e.snapToGrid(f,g),a.dia.CellView.prototype.pointermove.apply(this,arguments)}},pointerup:function(b,c,d){this._linkView?(this._linkView.pointerup(b,c,d),delete this._linkView):(this._inProcessOfEmbedding&&(this.finalizeEmbedding(),this._inProcessOfEmbedding=!1),a.dia.CellView.prototype.pointerup.apply(this,arguments)),this.model.trigger("batch:stop")}})}),"object"==typeof exports&&(module.exports.Element=joint.dia.Element,module.exports.ElementView=joint.dia.ElementView),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.dia.Link=a.dia.Cell.extend({markup:['<path class="connection" stroke="black"/>','<path class="marker-source" fill="black" stroke="black" />','<path class="marker-target" fill="black" stroke="black" />','<path class="connection-wrap"/>','<g class="labels"/>','<g class="marker-vertices"/>','<g class="marker-arrowheads"/>','<g class="link-tools"/>'].join(""),labelMarkup:['<g class="label">',"<rect />","<text />","</g>"].join(""),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="11" />','<path transform="scale(.8) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z"/>',"<title>Remove link.</title>","</g>",'<g class="tool-options" event="link:options">','<circle r="11" transform="translate(25)"/>','<path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/>',"<title>Link options.</title>","</g>","</g>"].join(""),vertexMarkup:['<g class="marker-vertex-group" transform="translate(<%= x %>, <%= y %>)">','<circle class="marker-vertex" idx="<%= idx %>" r="10" />','<path class="marker-vertex-remove-area" idx="<%= idx %>" d="M16,5.333c-7.732,0-14,4.701-14,10.5c0,1.982,0.741,3.833,2.016,5.414L2,25.667l5.613-1.441c2.339,1.317,5.237,2.107,8.387,2.107c7.732,0,14-4.701,14-10.5C30,10.034,23.732,5.333,16,5.333z" transform="translate(5, -33)"/>','<path class="marker-vertex-remove" idx="<%= idx %>" transform="scale(.8) translate(9.5, -37)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z">',"<title>Remove vertex.</title>","</path>","</g>"].join(""),arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<path class="marker-arrowhead" end="<%= end %>" d="M 26 0 L 0 13 L 26 26 z" />',"</g>"].join(""),defaults:{type:"link",source:{},target:{}},disconnect:function(){return this.set({source:e.point(0,0),target:e.point(0,0)})},label:function(a,c){a=a||0;var d=this.get("labels")||[];if(0===arguments.length||1===arguments.length)return d[a];var e=b.merge({},d[a],c),f=d.slice();return f[a]=e,this.set({labels:f})},translate:function(a,c,d){var e={},f=this.get("source"),g=this.get("target"),h=this.get("vertices");return f.id||(e.source={x:f.x+a,y:f.y+c}),g.id||(e.target={x:g.x+a,y:g.y+c}),h&&h.length&&(e.vertices=b.map(h,function(b){return{x:b.x+a,y:b.y+c}})),this.set(e,d)},reparent:function(a){var b;if(this.collection){var c=this.collection.get(this.get("source").id),d=this.collection.get(this.get("target").id),e=this.collection.get(this.get("parent"));c&&d&&(b=this.collection.getCommonAncestor(c,d)),!e||b&&b.id==e.id||e.unembed(this,a),b&&b.embed(this,a)}return b},isLink:function(){return!0},hasLoop:function(){var a=this.get("source").id,b=this.get("target").id;return a&&b&&a==b}}),a.dia.LinkView=a.dia.CellView.extend({className:function(){return b.unique(this.model.get("type").split(".").concat("link")).join(" ")},options:{shortLinkLength:100,doubleLinkTools:!1,longLinkLength:160,linkToolsOffset:40,doubleLinkToolsOffset:60},initialize:function(b){a.dia.CellView.prototype.initialize.apply(this,arguments),"function"!=typeof this.constructor.prototype.watchSource&&(this.constructor.prototype.watchSource=this.createWatcher("source"),this.constructor.prototype.watchTarget=this.createWatcher("target")),this._labelCache={},this._markerCache={},this.startListening()},startListening:function(){this.listenTo(this.model,"change:markup",this.render),this.listenTo(this.model,"change:smooth change:manhattan change:router change:connector",this.update),this.listenTo(this.model,"change:toolMarkup",function(){this.renderTools().updateToolsPosition()}),this.listenTo(this.model,"change:labels change:labelMarkup",function(){this.renderLabels().updateLabelPositions()}),this.listenTo(this.model,"change:vertices change:vertexMarkup",function(a,b,c){this.renderVertexMarkers(),(!c.translateBy||c.translateBy==this.model.id||this.model.hasLoop())&&this.update()}),this.listenTo(this.model,"change:source",function(a,b){this.watchSource(a,b).update()}),this.listenTo(this.model,"change:target",function(a,b){this.watchTarget(a,b).update()})},render:function(){this.$el.empty();var a=d(this.model.get("markup")||this.model.markup);if(b.isArray(a)||(a=[a]),this._V={},b.each(a,function(a){var b=a.attr("class");b&&(this._V[f.camelCase(b)]=a)},this),!this._V.connection)throw new Error("link: no connection path in the markup");return this.renderTools(),this.renderVertexMarkers(),this.renderArrowheadMarkers(),d(this.el).append(a),
this.renderLabels(),this.watchSource(this.model,this.model.get("source")).watchTarget(this.model,this.model.get("target")).update(),this},renderLabels:function(){if(!this._V.labels)return this;this._labelCache={};var c=f(this._V.labels.node).empty(),e=this.model.get("labels")||[];if(!e.length)return this;var g=b.template(this.model.get("labelMarkup")||this.model.labelMarkup),h=d(g());return b.each(e,function(e,g){var i=h.clone().node;this._labelCache[g]=d(i);var j=f(i).find("text"),k=f(i).find("rect"),l=b.extend({"text-anchor":"middle","font-size":14},a.util.getByPath(e,"attrs/text","/"));j.attr(b.omit(l,"text")),b.isUndefined(l.text)||d(j[0]).text(l.text+""),c.append(i);var m=d(j[0]).bbox(!0,c[0]);d(j[0]).translate(0,-m.height/2);var n=b.extend({fill:"white",rx:3,ry:3},a.util.getByPath(e,"attrs/rect","/"));k.attr(b.extend(n,{x:m.x,y:m.y-m.height/2,width:m.width,height:m.height}))},this),this},renderTools:function(){if(!this._V.linkTools)return this;var a=f(this._V.linkTools.node).empty(),c=b.template(this.model.get("toolMarkup")||this.model.toolMarkup),e=d(c());if(a.append(e.node),this._toolCache=e,this.options.doubleLinkTools){var g=e.clone();a.append(g.node),this._tool2Cache=g}return this},renderVertexMarkers:function(){if(!this._V.markerVertices)return this;var a=f(this._V.markerVertices.node).empty(),c=b.template(this.model.get("vertexMarkup")||this.model.vertexMarkup);return b.each(this.model.get("vertices"),function(e,f){a.append(d(c(b.extend({idx:f},e))).node)}),this},renderArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;var a=f(this._V.markerArrowheads.node);a.empty();var c=b.template(this.model.get("arrowheadMarkup")||this.model.arrowheadMarkup);return this._V.sourceArrowhead=d(c({end:"source"})),this._V.targetArrowhead=d(c({end:"target"})),a.append(this._V.sourceArrowhead.node,this._V.targetArrowhead.node),this},update:function(){b.each(this.model.get("attrs"),function(a,c){var d=[];b.isObject(a.fill)&&(this.applyGradient(c,"fill",a.fill),d.push("fill")),b.isObject(a.stroke)&&(this.applyGradient(c,"stroke",a.stroke),d.push("stroke")),b.isObject(a.filter)&&(this.applyFilter(c,a.filter),d.push("filter")),d.length>0&&(d.unshift(a),a=b.omit.apply(b,d)),this.findBySelector(c).attr(a)},this);var a=this.route=this.findRoute(this.model.get("vertices")||[]);this._findConnectionPoints(a);var c=this.getPathData(a);return this._V.connection.attr("d",c),this._V.connectionWrap&&this._V.connectionWrap.attr("d",c),this._translateAndAutoOrientArrows(this._V.markerSource,this._V.markerTarget),this.updateLabelPositions(),this.updateToolsPosition(),this.updateArrowheadMarkers(),delete this.options.perpendicular,this.updatePostponed=!1,this},_findConnectionPoints:function(a){var c,d,f,g,h=b.first(a);c=this.getConnectionPoint("source",this.model.get("source"),h||this.model.get("target")).round();var i=b.last(a);d=this.getConnectionPoint("target",this.model.get("target"),i||c).round();var j=this._markerCache;this._V.markerSource&&(j.sourceBBox=j.sourceBBox||this._V.markerSource.bbox(!0),f=e.point(c).move(h||d,j.sourceBBox.width*this._V.markerSource.scale().sx*-1).round()),this._V.markerTarget&&(j.targetBBox=j.targetBBox||this._V.markerTarget.bbox(!0),g=e.point(d).move(i||c,j.targetBBox.width*this._V.markerTarget.scale().sx*-1).round()),j.sourcePoint=f||c,j.targetPoint=g||d,this.sourcePoint=c,this.targetPoint=d},updateLabelPositions:function(){if(!this._V.labels)return this;var a=this.model.get("labels")||[];if(!a.length)return this;var c=this._V.connection.node,d=c.getTotalLength();return b.isNaN(d)||b.each(a,function(a,b){var e=a.position;e=e>d?d:e,e=0>e?d+e:e,e=e>1?e:d*e;var f=c.getPointAtLength(e);this._labelCache[b].attr("transform","translate("+f.x+", "+f.y+")")},this),this},updateToolsPosition:function(){if(!this._V.linkTools)return this;var a="",b=this.options.linkToolsOffset,c=this.getConnectionLength();c<this.options.shortLinkLength&&(a="scale(.5)",b/=2);var d=this.getPointAtLength(b);if(this._toolCache.attr("transform","translate("+d.x+", "+d.y+") "+a),this.options.doubleLinkTools&&c>=this.options.longLinkLength){var e=this.options.doubleLinkToolsOffset||b;d=this.getPointAtLength(c-e),this._tool2Cache.attr("transform","translate("+d.x+", "+d.y+") "+a),this._tool2Cache.attr("visibility","visible")}else this.options.doubleLinkTools&&this._tool2Cache.attr("visibility","hidden");return this},updateArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;if("none"===f.css(this._V.markerArrowheads.node,"display"))return this;var a=this.getConnectionLength()<this.options.shortLinkLength?.5:1;return this._V.sourceArrowhead.scale(a),this._V.targetArrowhead.scale(a),this._translateAndAutoOrientArrows(this._V.sourceArrowhead,this._V.targetArrowhead),this},createWatcher:function(a){function c(b,c){c=c||{};var e=null,f=b.previous(a)||{};return f.id&&this.stopListening(this.paper.getModelById(f.id),"change",d),c.id&&(e=this.paper.getModelById(c.id),this.listenTo(e,"change",d)),d.call(this,e,{cacheOnly:!0}),this}var d=b.partial(this.onEndModelChange,a);return c},onEndModelChange:function(a,c,d){var f=!d.cacheOnly,g=this.model.get(a)||{};if(c){var h=this.constructor.makeSelector(g),i="source"==a?"target":"source",j=this.model.get(i)||{},k=j.id&&this.constructor.makeSelector(j);if(d.isLoop&&h==k)this[a+"BBox"]=this[i+"BBox"],this[a+"View"]=this[i+"View"],this[a+"Magnet"]=this[i+"Magnet"];else if(d.translateBy){var l=this[a+"BBox"];l.x+=d.tx,l.y+=d.ty}else{var m=this.paper.findViewByModel(g.id),n=m.el.querySelector(h);this[a+"BBox"]=m.getStrokeBBox(n),this[a+"View"]=m,this[a+"Magnet"]=n}if(d.isLoop&&d.translateBy&&this.model.isEmbeddedIn(c)&&!b.isEmpty(this.model.get("vertices"))&&(f=!1),!this.updatePostponed&&j.id){var o=this.paper.getModelById(j.id);d.isLoop=g.id==j.id,(d.isLoop||d.translateBy&&o.isEmbeddedIn(d.translateBy))&&(this.updatePostponed=!0,f=!1)}}else this[a+"BBox"]=e.rect(g.x||0,g.y||0,1,1),this[a+"View"]=this[a+"Magnet"]=null;this.lastEndChange=a,f&&this.update()},_translateAndAutoOrientArrows:function(a,c){a&&a.translateAndAutoOrient(this.sourcePoint,b.first(this.route)||this.targetPoint,this.paper.viewport),c&&c.translateAndAutoOrient(this.targetPoint,b.last(this.route)||this.sourcePoint,this.paper.viewport)},removeVertex:function(a){var c=b.clone(this.model.get("vertices"));return c&&c.length&&(c.splice(a,1),this.model.set("vertices",c,{ui:!0})),this},addVertex:function(a){for(var b,c=(this.model.get("vertices")||[]).slice(),e=c.slice(),f=this._V.connection.node.cloneNode(!1),g=f.getTotalLength(),h=20,i=c.length+1;i--&&(c.splice(i,0,a),d(f).attr("d",this.getPathData(this.findRoute(c))),b=f.getTotalLength(),b-g>h);)c=e.slice();return-1===i&&(i=0,c.splice(i,0,a)),this.model.set("vertices",c,{ui:!0}),i},sendToken:function(a,c,e){c=c||1e3,d(this.paper.viewport).append(a),d(a).animateAlongPath({dur:c+"ms",repeatCount:1},this._V.connection.node),b.delay(function(){d(a).remove(),e&&e()},c)},findRoute:function(c){var d=this.model.get("router");if(!d){if(!this.model.get("manhattan"))return c;d={name:"orthogonal"}}var e=a.routers[d.name];if(!b.isFunction(e))throw"unknown router: "+d.name;var f=e.call(this,c||[],d.args||{},this);return f},getPathData:function(c){var d=this.model.get("connector");if(d||(d=this.model.get("smooth")?{name:"smooth"}:{name:"normal"}),!b.isFunction(a.connectors[d.name]))throw"unknown connector: "+d.name;var e=a.connectors[d.name].call(this,this._markerCache.sourcePoint,this._markerCache.targetPoint,c||this.model.get("vertices")||{},d.args||{},this);return e},getConnectionPoint:function(a,c,d){var f;if(b.isEmpty(c)&&(c={x:0,y:0}),b.isEmpty(d)&&(d={x:0,y:0}),c.id){var g,h="source"===a?this.sourceBBox:this.targetBBox;if(d.id){var i="source"===a?this.targetBBox:this.sourceBBox;g=e.rect(i).intersectionWithLineFromCenterToPoint(e.rect(h).center()),g=g||e.rect(i).center()}else g=e.point(d);if(this.paper.options.perpendicularLinks||this.options.perpendicular){var j,k=e.rect(0,g.y,this.paper.options.width,1),l=e.rect(g.x,0,1,this.paper.options.height);if(k.intersect(e.rect(h)))switch(j=e.rect(h).sideNearestToPoint(g)){case"left":f=e.point(h.x,g.y);break;case"right":f=e.point(h.x+h.width,g.y);break;default:f=e.rect(h).center()}else if(l.intersect(e.rect(h)))switch(j=e.rect(h).sideNearestToPoint(g)){case"top":f=e.point(g.x,h.y);break;case"bottom":f=e.point(g.x,h.y+h.height);break;default:f=e.rect(h).center()}else f=e.rect(h).intersectionWithLineFromCenterToPoint(g),f=f||e.rect(h).center()}else if(this.paper.options.linkConnectionPoint){var m="target"===a?this.targetView:this.sourceView,n="target"===a?this.targetMagnet:this.sourceMagnet;f=this.paper.options.linkConnectionPoint(this,m,n,g)}else f=e.rect(h).intersectionWithLineFromCenterToPoint(g),f=f||e.rect(h).center()}else f=e.point(c);return f},getConnectionLength:function(){return this._V.connection.node.getTotalLength()},getPointAtLength:function(a){return this._V.connection.node.getPointAtLength(a)},_beforeArrowheadMove:function(){this.model.trigger("batch:start"),this._z=this.model.get("z"),this.model.toFront(),this.el.style.pointerEvents="none",this.paper.options.markAvailable&&this._markAvailableMagnets()},_afterArrowheadMove:function(){this._z&&(this.model.set("z",this._z,{ui:!0}),delete this._z),this.el.style.pointerEvents="visiblePainted",this.paper.options.markAvailable&&this._unmarkAvailableMagnets(),this.model.trigger("batch:stop")},_createValidateConnectionArgs:function(a){function b(a,b){return c[f]=a,c[f+1]=a.el===b?void 0:b,c}var c=[];c[4]=a,c[5]=this;var d,e=0,f=0;"source"===a?(e=2,d="target"):(f=2,d="source");var g=this.model.get(d);return g.id&&(c[e]=this.paper.findViewByModel(g.id),c[e+1]=g.selector&&c[e].el.querySelector(g.selector)),b},_markAvailableMagnets:function(){var a=this.paper.model.getElements(),c=this.paper.options.validateConnection;b.chain(a).map(this.paper.findViewByModel,this.paper).each(function(a){var e="false"!==a.el.getAttribute("magnet")&&c.apply(this.paper,this._validateConnectionArgs(a,null)),f=b.filter(a.el.querySelectorAll("[magnet]"),function(b){return c.apply(this.paper,this._validateConnectionArgs(a,b))},this);e&&d(a.el).addClass("available-magnet"),b.each(f,function(a){d(a).addClass("available-magnet")}),(e||f.length)&&d(a.el).addClass("available-cell")},this)},_unmarkAvailableMagnets:function(){b.each(this.paper.el.querySelectorAll(".available-cell, .available-magnet"),function(a){d(a).removeClass("available-magnet").removeClass("available-cell")})},startArrowheadMove:function(a){this._action="arrowhead-move",this._arrowhead=a,this._validateConnectionArgs=this._createValidateConnectionArgs(this._arrowhead),this._beforeArrowheadMove()},pointerdown:function(c,d,e){function f(a){return b.isObject(g)&&g[a]===!1?!1:!0}a.dia.CellView.prototype.pointerdown.apply(this,arguments),this._dx=d,this._dy=e;var g=b.isFunction(this.options.interactive)?this.options.interactive(this,"pointerdown"):this.options.interactive;if(g!==!1){var h=c.target.getAttribute("class");switch(h){case"marker-vertex":f("vertexMove")&&(this._action="vertex-move",this._vertexIdx=c.target.getAttribute("idx"));break;case"marker-vertex-remove":case"marker-vertex-remove-area":f("vertexRemove")&&this.removeVertex(c.target.getAttribute("idx"));break;case"marker-arrowhead":f("arrowheadMove")&&this.startArrowheadMove(c.target.getAttribute("end"));break;default:var i=c.target.parentNode.getAttribute("event");i?"remove"===i?this.model.remove():this.paper.trigger(i,c,this,d,e):f("vertexAdd")&&(this._vertexIdx=this.addVertex({x:d,y:e}),this._action="vertex-move")}this.paper.trigger("link:pointerdown",c,this,d,e)}},pointermove:function(c,f,g){switch(a.dia.CellView.prototype.pointermove.apply(this,arguments),this._action){case"vertex-move":var h=b.clone(this.model.get("vertices"));h[this._vertexIdx]={x:f,y:g},this.model.set("vertices",h,{ui:!0});break;case"arrowhead-move":if(this.paper.options.snapLinks){var i=this.paper.options.snapLinks.radius||50,j=this.paper.findViewsInArea({x:f-i,y:g-i,width:2*i,height:2*i});this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this._closestView=this._closestEnd=null;var k,l=e.point(f,g),m=Number.MAX_VALUE;b.each(j,function(a){"false"!==a.el.getAttribute("magnet")&&(k=a.model.getBBox().center().distance(l),i>k&&m>k&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(a,null))&&(m=k,this._closestView=a,this._closestEnd={id:a.model.id})),a.$("[magnet]").each(b.bind(function(b,c){var e=d(c).bbox(!1,this.paper.viewport);k=l.distance({x:e.x+e.width/2,y:e.y+e.height/2}),i>k&&m>k&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(a,c))&&(m=k,this._closestView=a,this._closestEnd={id:a.model.id,selector:a.getSelector(c),port:c.getAttribute("port")})},this))},this),this._closestView&&this._closestView.highlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this.model.set(this._arrowhead,this._closestEnd||{x:f,y:g},{ui:!0})}else{var n="mousemove"===c.type?c.target:document.elementFromPoint(c.clientX,c.clientY);this._targetEvent!==n&&(this._magnetUnderPointer&&this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),this._viewUnderPointer=this.paper.findView(n),this._viewUnderPointer?(this._magnetUnderPointer=this._viewUnderPointer.findMagnet(n),this._magnetUnderPointer&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(this._viewUnderPointer,this._magnetUnderPointer))?this._magnetUnderPointer&&this._viewUnderPointer.highlight(this._magnetUnderPointer,{connecting:!0}):this._magnetUnderPointer=null):this._magnetUnderPointer=null),this._targetEvent=n,this.model.set(this._arrowhead,{x:f,y:g},{ui:!0})}}this._dx=f,this._dy=g},pointerup:function(b){a.dia.CellView.prototype.pointerup.apply(this,arguments),"arrowhead-move"===this._action&&(this.paper.options.snapLinks?(this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this._closestView=this._closestEnd=null):(this._magnetUnderPointer&&(this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),this.model.set(this._arrowhead,{id:this._viewUnderPointer.model.id,selector:this._viewUnderPointer.getSelector(this._magnetUnderPointer),port:f(this._magnetUnderPointer).attr("port")},{ui:!0})),delete this._viewUnderPointer,delete this._magnetUnderPointer),this.paper.options.embeddingMode&&this.model.reparent()&&delete this._z,this._afterArrowheadMove()),delete this._action}},{makeSelector:function(a){var b='[model-id="'+a.id+'"]';return a.port?b+=' [port="'+a.port+'"]':a.selector&&(b+=" "+a.selector),b}})}),"object"==typeof exports&&(module.exports.Link=joint.dia.Link,module.exports.LinkView=joint.dia.LinkView),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.dia.Paper=c.View.extend({className:"paper",options:{width:800,height:600,origin:{x:0,y:0},gridSize:50,perpendicularLinks:!1,elementView:a.dia.ElementView,linkView:a.dia.LinkView,snapLinks:!1,markAvailable:!1,defaultLink:new a.dia.Link,validateMagnet:function(a,b){return"passive"!==b.getAttribute("magnet")},validateConnection:function(b,c,d,e,f,g){return("target"===f?d:b)instanceof a.dia.ElementView},embeddingMode:!1,validateEmbedding:function(a,b){return!0},findParentBy:"bbox",frontParentOnly:!0},events:{mousedown:"pointerdown",dblclick:"mousedblclick",click:"mouseclick",touchstart:"pointerdown",mousemove:"pointermove",touchmove:"pointermove","mouseover .element":"cellMouseover","mouseover .link":"cellMouseover","mouseout .element":"cellMouseout","mouseout .link":"cellMouseout"},constructor:function(a){this._configure(a),c.View.apply(this,arguments)},_configure:function(a){this.options&&(a=b.extend({},b.result(this,"options"),a)),this.options=a},initialize:function(){b.bindAll(this,"addCell","sortCells","resetCells","pointerup","asyncRenderCells"),this.svg=d("svg").node,this.viewport=d("g").addClass("viewport").node,this.defs=d("defs").node,d(this.svg).append([this.viewport,this.defs]),this.$el.append(this.svg),this.setOrigin(),this.setDimensions(),this.listenTo(this.model,"add",this.onAddCell),this.listenTo(this.model,"reset",this.resetCells),this.listenTo(this.model,"sort",this.sortCells),f(document).on("mouseup touchend",this.pointerup),this._mousemoved=!1,this.on({"cell:highlight":this.onCellHighlight,"cell:unhighlight":this.onCellUnhighlight})},remove:function(){this.removeCells(),f(document).off("mouseup touchend",this.pointerup),c.View.prototype.remove.call(this)},setDimensions:function(a,b){a=this.options.width=a||this.options.width,b=this.options.height=b||this.options.height,d(this.svg).attr({width:a,height:b}),this.trigger("resize",a,b)},setOrigin:function(a,b){this.options.origin.x=a||0,this.options.origin.y=b||0,d(this.viewport).translate(a,b,{absolute:!0}),this.trigger("translate",a,b)},fitToContent:function(a,c,e,f){b.isObject(a)?(f=a,a=f.gridWidth||1,c=f.gridHeight||1,e=f.padding||0):(f=f||{},a=a||1,c=c||1,e=e||0);var g=d(this.viewport).bbox(!0,this.svg),h=d(this.viewport).scale();g.x*=h.sx,g.y*=h.sy,g.width*=h.sx,g.height*=h.sy;var i=Math.max(Math.ceil((g.width+g.x)/a),1)*a,j=Math.max(Math.ceil((g.height+g.y)/c),1)*c,k=0,l=0;("negative"==f.allowNewOrigin&&g.x<0||"positive"==f.allowNewOrigin&&g.x>=0||"any"==f.allowNewOrigin)&&(k=Math.ceil(-g.x/a)*a,k+=e,i+=k),("negative"==f.allowNewOrigin&&g.y<0||"positive"==f.allowNewOrigin&&g.y>=0||"any"==f.allowNewOrigin)&&(l=Math.ceil(-g.y/c)*c,l+=e,j+=l),i+=e,j+=e,i=Math.max(i,f.minWidth||0),j=Math.max(j,f.minHeight||0);var m=i!=this.options.width||j!=this.options.height,n=k!=this.options.origin.x||l!=this.options.origin.y;n&&this.setOrigin(k,l),m&&this.setDimensions(i,j)},scaleContentToFit:function(a){var c=this.getContentBBox();if(c.width&&c.height){a=a||{},b.defaults(a,{padding:0,preserveAspectRatio:!0,scaleGrid:null,minScale:0,maxScale:Number.MAX_VALUE});var f=a.padding,g=a.minScaleX||a.minScale,h=a.maxScaleX||a.maxScale,i=a.minScaleY||a.minScale,j=a.maxScaleY||a.maxScale,k=a.fittingBBox||{x:this.options.origin.x,y:this.options.origin.y,width:this.options.width,height:this.options.height};k=e.rect(k).moveAndExpand({x:f,y:f,width:-2*f,height:-2*f});var l=d(this.viewport).scale(),m=k.width/c.width*l.sx,n=k.height/c.height*l.sy;if(a.preserveAspectRatio&&(m=n=Math.min(m,n)),a.scaleGrid){var o=a.scaleGrid;m=o*Math.floor(m/o),n=o*Math.floor(n/o)}m=Math.min(h,Math.max(g,m)),n=Math.min(j,Math.max(i,n)),this.scale(m,n);var p=this.getContentBBox(),q=k.x-p.x,r=k.y-p.y;this.setOrigin(q,r)}},getContentBBox:function(){var a=this.viewport.getBoundingClientRect(),b=this.viewport.getScreenCTM(),c=this.viewport.getCTM(),d=e.rect({x:a.left-b.e+c.e,y:a.top-b.f+c.f,width:a.width,height:a.height});return d},createViewForModel:function(b){var c,d=b.get("type"),e=d.split(".")[0],f=d.split(".")[1];return c=a.shapes[e]&&a.shapes[e][f+"View"]?new a.shapes[e][f+"View"]({model:b,interactive:this.options.interactive}):b instanceof a.dia.Element?new this.options.elementView({model:b,interactive:this.options.interactive}):new this.options.linkView({model:b,interactive:this.options.interactive})},onAddCell:function(a,c,d){if(this.options.async&&d.async!==!1&&b.isNumber(d.position)){if(this._asyncCells=this._asyncCells||[],this._asyncCells.push(a),0==d.position){if(this._frameId)throw"another asynchronous rendering in progress";this.asyncRenderCells(this._asyncCells),delete this._asyncCells}}else this.addCell(a)},addCell:function(a){var b=this.createViewForModel(a);d(this.viewport).append(b.el),b.paper=this,b.render(),f(b.el).find("image").on("dragstart",function(){return!1})},beforeRenderCells:function(b){return b.sort(function(b,c){return b instanceof a.dia.Link?1:-1}),b},afterRenderCells:function(){this.sortCells()},resetCells:function(c){f(this.viewport).empty();var d=c.models.slice();d=this.beforeRenderCells(d),this._frameId&&(a.util.cancelFrame(this._frameId),delete this._frameId),this.options.async?this.asyncRenderCells(d):(b.each(d,this.addCell,this),this.sortCells())},removeCells:function(){this.model.get("cells").each(function(a){var b=this.findViewByModel(a);b&&b.remove()},this)},asyncBatchAdded:b.identity,asyncRenderCells:function(c,d){var e=!1;this._frameId&&(b.each(b.range(this.options.async&&this.options.async.batchSize||50),function(){var a=c.shift();e=!a,e||this.addCell(a)},this),this.asyncBatchAdded()),e?(delete this._frameId,this.afterRenderCells(),this.trigger("render:done",d)):this._frameId=a.util.nextFrame(b.bind(function(){this.asyncRenderCells(c,d)},this))},sortCells:function(){var a=f(this.viewport).children("[model-id]"),b=this.model.get("cells");this.sortElements(a,function(a,c){var d=b.get(f(a).attr("model-id")),e=b.get(f(c).attr("model-id"));return(d.get("z")||0)>(e.get("z")||0)?1:-1})},sortElements:function(a,b){var c=f(a),d=c.map(function(){var a=this,b=a.parentNode,c=b.insertBefore(document.createTextNode(""),a.nextSibling);return function(){if(b===this)throw new Error("You can't sort elements if any one is a descendant of another.");b.insertBefore(this,c),b.removeChild(c)}});return Array.prototype.sort.call(c,b).each(function(a){d[a].call(this)})},scale:function(a,c,e,f){c=c||a,b.isUndefined(e)&&(e=0,f=0),d(this.viewport).attr("transform","");var g=this.options.origin.x,h=this.options.origin.y;if(e||f||g||h){var i=g-e*(a-1),j=h-f*(c-1);this.setOrigin(i,j)}return d(this.viewport).scale(a,c),this.trigger("scale",a,c,e,f),this},rotate:function(a,c,e){if(b.isUndefined(c)){var f=this.viewport.getBBox();c=f.width/2,e=f.height/2}d(this.viewport).rotate(a,c,e)},findView:function(a){var b=this.$(a);return 0===b.length||b[0]===this.el?void 0:b.data("view")?b.data("view"):this.findView(b.parent())},findViewByModel:function(a){var c=b.isString(a)?a:a.id,d=this.$('[model-id="'+c+'"]');return d.length?d.data("view"):void 0},findViewsFromPoint:function(a){a=e.point(a);var c=b.map(this.model.getElements(),this.findViewByModel);return b.filter(c,function(b){return b&&e.rect(d(b.el).bbox(!1,this.viewport)).containsPoint(a)},this)},findViewsInArea:function(a){a=e.rect(a);var c=b.map(this.model.getElements(),this.findViewByModel);return b.filter(c,function(b){return b&&a.intersect(e.rect(d(b.el).bbox(!1,this.viewport)))},this)},getModelById:function(a){return this.model.getCell(a)},snapToGrid:function(a){var b=d(this.viewport).toLocalPoint(a.x,a.y);return{x:e.snapToGrid(b.x,this.options.gridSize),y:e.snapToGrid(b.y,this.options.gridSize)}},getDefaultLink:function(a,c){return b.isFunction(this.options.defaultLink)?this.options.defaultLink.call(this,a,c):this.options.defaultLink.clone()},onCellHighlight:function(a,b){d(b).addClass("highlighted")},onCellUnhighlight:function(a,b){d(b).removeClass("highlighted")},mousedblclick:function(b){b.preventDefault(),b=a.util.normalizeEvent(b);var c=this.findView(b.target),d=this.snapToGrid({x:b.clientX,y:b.clientY});c?c.pointerdblclick(b,d.x,d.y):this.trigger("blank:pointerdblclick",b,d.x,d.y)},mouseclick:function(b){if(!this._mousemoved){b=a.util.normalizeEvent(b);var c=this.findView(b.target),d=this.snapToGrid({x:b.clientX,y:b.clientY});c?c.pointerclick(b,d.x,d.y):this.trigger("blank:pointerclick",b,d.x,d.y)}this._mousemoved=!1},pointerdown:function(b){b=a.util.normalizeEvent(b);var c=this.findView(b.target),d=this.snapToGrid({x:b.clientX,y:b.clientY});c?(this.sourceView=c,c.pointerdown(b,d.x,d.y)):this.trigger("blank:pointerdown",b,d.x,d.y)},pointermove:function(b){if(b.preventDefault(),b=a.util.normalizeEvent(b),this.sourceView){this._mousemoved=!0;var c=this.snapToGrid({x:b.clientX,y:b.clientY});this.sourceView.pointermove(b,c.x,c.y)}},pointerup:function(b){b=a.util.normalizeEvent(b);var c=this.snapToGrid({x:b.clientX,y:b.clientY});this.sourceView?(this.sourceView.pointerup(b,c.x,c.y),this.sourceView=null):this.trigger("blank:pointerup",b,c.x,c.y)},cellMouseover:function(b){b=a.util.normalizeEvent(b);var c=this.findView(b.target);c&&c.mouseover(b)},cellMouseout:function(b){b=a.util.normalizeEvent(b);var c=this.findView(b.target);c&&c.mouseout(b)}})}),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");module.exports=b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.shapes.basic={},a.shapes.basic.Generic=a.dia.Element.extend({defaults:a.util.deepSupplement({type:"basic.Generic",attrs:{".":{fill:"#FFFFFF",stroke:"none"}}},a.dia.Element.prototype.defaults)}),a.shapes.basic.Rect=a.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><rect/></g><text/></g>',defaults:a.util.deepSupplement({type:"basic.Rect",attrs:{rect:{fill:"#FFFFFF",stroke:"black",width:100,height:60},text:{"font-size":14,text:"","ref-x":.5,"ref-y":.5,ref:"rect","y-alignment":"middle","x-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},a.shapes.basic.Generic.prototype.defaults)}),a.shapes.basic.TextView=a.dia.ElementView.extend({initialize:function(){a.dia.ElementView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:attrs",this.resize)}}),a.shapes.basic.Text=a.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><text/></g></g>',defaults:a.util.deepSupplement({type:"basic.Text",attrs:{text:{"font-size":18,fill:"black"}}},a.shapes.basic.Generic.prototype.defaults)}),a.shapes.basic.Circle=a.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><circle/></g><text/></g>',defaults:a.util.deepSupplement({type:"basic.Circle",size:{width:60,height:60},attrs:{circle:{fill:"#FFFFFF",stroke:"black",r:30,transform:"translate(30, 30)"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-y":.5,ref:"circle","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},a.shapes.basic.Generic.prototype.defaults)}),a.shapes.basic.Image=a.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><image/></g><text/></g>',defaults:a.util.deepSupplement({type:"basic.Image",attrs:{text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,ref:"image","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},a.shapes.basic.Generic.prototype.defaults)}),a.shapes.basic.Path=a.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><path/></g><text/></g>',defaults:a.util.deepSupplement({type:"basic.Path",size:{width:60,height:60},attrs:{path:{fill:"#FFFFFF",stroke:"black"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,ref:"path","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},a.shapes.basic.Generic.prototype.defaults)}),a.shapes.basic.Rhombus=a.shapes.basic.Path.extend({defaults:a.util.deepSupplement({type:"basic.Rhombus",attrs:{path:{d:"M 30 0 L 60 30 30 60 0 30 z"},text:{"ref-y":.5}}},a.shapes.basic.Path.prototype.defaults)}),a.shapes.basic.PortsModelInterface={initialize:function(){this.updatePortsAttrs(),this.on("change:inPorts change:outPorts",this.updatePortsAttrs,this),this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments)},updatePortsAttrs:function(a){var c=this.get("attrs");b.each(this._portSelectors,function(a){c[a]&&delete c[a]}),this._portSelectors=[];var d={};b.each(this.get("inPorts"),function(a,c,e){var f=this.getPortAttrs(a,c,e.length,".inPorts","in");this._portSelectors=this._portSelectors.concat(b.keys(f)),b.extend(d,f)},this),b.each(this.get("outPorts"),function(a,c,e){var f=this.getPortAttrs(a,c,e.length,".outPorts","out");this._portSelectors=this._portSelectors.concat(b.keys(f)),b.extend(d,f)},this),this.attr(d,{silent:!0}),this.processPorts(),this.trigger("process:ports")},getPortSelector:function(a){var b=".inPorts",c=this.get("inPorts").indexOf(a);if(0>c&&(b=".outPorts",c=this.get("outPorts").indexOf(a),0>c))throw new Error("getPortSelector(): Port doesn't exist.");return b+">g:nth-child("+(c+1)+")>circle"}},a.shapes.basic.PortsViewInterface={initialize:function(){this.listenTo(this.model,"process:ports",this.update),a.dia.ElementView.prototype.initialize.apply(this,arguments)},update:function(){this.renderPorts(),a.dia.ElementView.prototype.update.apply(this,arguments)},renderPorts:function(){var a=this.$(".inPorts").empty(),c=this.$(".outPorts").empty(),e=b.template(this.model.portMarkup);b.each(b.filter(this.model.ports,function(a){return"in"===a.type}),function(b,c){a.append(d(e({id:c,port:b})).node)}),b.each(b.filter(this.model.ports,function(a){return"out"===a.type}),function(a,b){c.append(d(e({id:b,port:a})).node)})}},a.shapes.basic.TextBlock=a.shapes.basic.Generic.extend({markup:['<g class="rotatable"><g class="scalable"><rect/></g><switch>','<foreignObject requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" class="fobj">','<body xmlns="http://www.w3.org/1999/xhtml"><div/></body>',"</foreignObject>",'<text class="content"/>',"</switch></g>"].join(""),defaults:a.util.deepSupplement({type:"basic.TextBlock",attrs:{rect:{fill:"#ffffff",stroke:"#000000",width:80,height:100},text:{fill:"#000000","font-size":14,"font-family":"Arial, helvetica, sans-serif"},".content":{text:"",ref:"rect","ref-x":.5,"ref-y":.5,"y-alignment":"middle","x-alignment":"middle"}},content:""},a.shapes.basic.Generic.prototype.defaults),initialize:function(){"undefined"!=typeof SVGForeignObjectElement&&(this.setForeignObjectSize(this,this.get("size")),this.setDivContent(this,this.get("content")),this.listenTo(this,"change:size",this.setForeignObjectSize),this.listenTo(this,"change:content",this.setDivContent)),a.shapes.basic.Generic.prototype.initialize.apply(this,arguments)},setForeignObjectSize:function(a,c){a.attr({".fobj":b.clone(c),div:{style:b.clone(c)}})},setDivContent:function(a,b){a.attr({div:{html:b}})}}),a.shapes.basic.TextBlockView=a.dia.ElementView.extend({initialize:function(){a.dia.ElementView.prototype.initialize.apply(this,arguments),"undefined"==typeof SVGForeignObjectElement&&(this.noSVGForeignObjectElement=!0,this.listenTo(this.model,"change:content",function(a){this.updateContent(a)}))},update:function(c,d){if(this.noSVGForeignObjectElement){var e=this.model,f=b.omit(d||e.get("attrs"),".content");a.dia.ElementView.prototype.update.call(this,e,f),(!d||b.has(d,".content"))&&this.updateContent(e,d)}else a.dia.ElementView.prototype.update.call(this,e,d)},updateContent:function(c,d){var e=b.merge({},(d||c.get("attrs"))[".content"]);delete e.text;var f=a.util.breakText(c.get("content"),c.get("size"),e,{svgDocument:this.paper.svg}),g=a.util.setByPath({},".content",e,"/");g[".content"].text=f,a.dia.ElementView.prototype.update.call(this,c,g)}})}),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.routers.orthogonal=function(){function a(a,b){return a.y<b.y&&a.x===b.x?"down":a.y>b.y&&a.x===b.x?"up":a.x<b.x&&a.y===b.y?"right":"left";

}function c(a,c,d){var e;if(e=a.x<c.x?a.y>c.y?["up","right"]:a.y<c.y?["down","right"]:["right"]:a.x>c.x?a.y>c.y?["up","left"]:a.y<c.y?["down","left"]:["left"]:a.y>c.y?["up"]:["down"],b.contains(e,d))return d;var f=b.first(e);switch(d){case"down":if("up"===f)return b.last(e);break;case"up":if("down"===f)return b.last(e);break;case"left":if("right"===f)return b.last(e);break;case"right":if("left"===f)return b.last(e)}return f}function d(a,b,d){var e=c(a,b,d);return"down"===e||"up"===e?{x:a.x,y:b.y,d:e}:{x:b.x,y:a.y,d:e}}function f(c){c=(c||[]).slice();var f=[],i=g.center(),j=h.center();c.length||(Math.abs(i.x-j.x)<g.width/2||Math.abs(i.y-j.y)<g.height/2)&&(c=[{x:Math.min(i.x,j.x)+Math.abs(i.x-j.x)/2,y:Math.min(i.y,j.y)+Math.abs(i.y-j.y)/2}]),c.unshift(i),c.push(j);for(var k,l,m,n,o=0;o<c.length-1;o++){m=c[o],n=c[o+1],l=b.last(f),o>0&&(k=m,k.d=l?a(l,m):"top",f.push(k),l=k);var p=l&&l.d;k=d(m,n,p),e.point(k).equals(e.point(m))||e.point(k).equals(e.point(n))||f.push(k)}return f}var g,h;return function(a){return g=this.sourceBBox,h=this.targetBBox,f(a)}}()}),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.routers.manhattan=function(){"use strict";function a(a,b){for(var c,d=[],e={x:0,y:0},f=b;c=a[f];){var g=c.difference(f);g.equals(e)||(d.unshift(f),e=g),f=c}return d.unshift(f),d}function c(a,c,d){var f=d.step,g=a.center(),h=b.chain(d.directionMap).pick(c).map(function(b){var c=b.x*a.width/2,d=b.y*a.height/2,h=e.point(g).offset(c,d).snapToGrid(f);return a.containsPoint(h)&&h.offset(b.x*f,b.y*f),h}).value();return h}function d(a,b,c){var d=360/c,e=Math.floor(a.theta(b)/d);return c-e}function f(f,g,h,i){var j=i.reversed?i.endDirections:i.startDirections,k=i.reversed?i.startDirections:i.endDirections,l=f instanceof e.rect?c(f,j,i):[f],m=g instanceof e.rect?c(g,k,i):[g],n=l.length>1?f.center():l[0],o=m.length>1?g.center():m[0],p=b.filter(m,function(a){var c=e.point(a).snapToGrid(i.mapGridSize).toString(),d=b.every(h[c],function(b){return!b.containsPoint(a)});return d});if(p.length)for(var q=i.step,r=i.penalties,s=b.chain(p).invoke("snapToGrid",q).min(function(a){return i.estimateCost(n,a)}).value(),t={},u={},v={},w=i.directions,x=w.length,y=x/2,z=i.previousDirIndexes||{},A={},B={},C=b.chain(l).invoke("snapToGrid",q).each(function(a){var b=a.toString();u[b]=0,v[b]=i.estimateCost(a,s),z[b]=z[b]||d(n,a,x),B[b]=!0}).map(function(a){return a.toString()}).sortBy(function(a){return v[a]}).value(),D=i.maximumLoops,E=i.maxAllowedDirectionChange;C.length&&D--;){var F=C[0],G=e.point(F);if(s.equals(G))return i.previousDirIndexes=b.pick(z,F),a(t,G);C.splice(0,1),B[N]=null,A[N]=!0;for(var H=z[F],I=u[F],J=0;x>J;J++){var K=Math.abs(J-H);if(K>y&&(K=x-K),!(K>E)){var L=w[J],M=e.point(G).offset(L.offsetX,L.offsetY),N=M.toString();if(!A[N]){var O=e.point(M).snapToGrid(i.mapGridSize).toString(),P=b.every(h[O],function(a){return!a.containsPoint(M)});if(P){var Q=b.has(B,N),R=I+L.cost;if((!Q||R<u[N])&&(t[N]=G,z[N]=J,u[N]=R,v[N]=R+i.estimateCost(M,s)+r[K],!Q)){var S=b.sortedIndex(C,N,function(a){return v[a]});C.splice(S,0,N),B[N]=!0}}}}}}return i.fallbackRoute(n,o,i)}function g(a,c){c.directions=b.result(c,"directions"),c.penalties=b.result(c,"penalties"),c.paddingBox=b.result(c,"paddingBox"),this.options.perpendicular=!!c.perpendicular;var d=c.reversed="source"===this.lastEndChange,g=e.rect(d?this.targetBBox:this.sourceBBox),h=e.rect(d?this.sourceBBox:this.targetBBox);g.moveAndExpand(c.paddingBox),h.moveAndExpand(c.paddingBox);var i=this.model,j=this.paper.model,k=b.chain(c.excludeEnds).map(i.get,i).pluck("id").map(j.getCell,j).value(),l=c.mapGridSize,m=b.chain(j.getElements()).difference(k).reject(function(a){return b.contains(c.excludeTypes,a.get("type"))}).invoke("getBBox").invoke("moveAndExpand",c.paddingBox).foldl(function(a,b){for(var c=b.origin().snapToGrid(l),d=b.corner().snapToGrid(l),e=c.x;e<=d.x;e+=l)for(var f=c.y;f<=d.y;f+=l){var g=e+"@"+f;a[g]=a[g]||[],a[g].push(b)}return a},{}).value(),n=[],o=b.map(a,e.point);d&&o.reverse();for(var p=g.center(),q=0,r=o.length;r>=q;q++){var s=null,t=u||g,u=o[q];if(!u){u=h;var v=!this.model.get("source").id||!this.model.get("target").id;if(v&&b.isFunction(c.draggingRoute)){var w=t instanceof e.rect?t.center():t;s=c.draggingRoute(w,u.origin(),c)}}s=s||f(t,u,m,c);var x=b.first(s);x&&x.equals(p)&&s.shift(),p=b.last(s)||p,n=n.concat(s)}return d?n.reverse():n}var h={step:10,perpendicular:!0,mapGridSize:100,excludeEnds:[],excludeTypes:["basic.Text"],maximumLoops:500,startDirections:["left","right","top","bottom"],endDirections:["left","right","top","bottom"],directionMap:{right:{x:1,y:0},bottom:{x:0,y:1},left:{x:-1,y:0},top:{x:0,y:-1}},maxAllowedDirectionChange:1,paddingBox:function(){var a=this.step;return{x:-a,y:-a,width:2*a,height:2*a}},directions:function(){var a=this.step;return[{offsetX:a,offsetY:0,cost:a},{offsetX:0,offsetY:a,cost:a},{offsetX:-a,offsetY:0,cost:a},{offsetX:0,offsetY:-a,cost:a}]},penalties:function(){return[0,this.step/2,this.step]},estimateCost:function(a,b){return a.manhattanDistance(b)},fallbackRoute:function(a,b,c){var d=c.prevDirIndexes||{},f=(d[a]||0)%2?e.point(a.x,b.y):e.point(b.x,a.y);return[f,b]},draggingRoute:null};return function(a,c,d){return g.call(d,a,b.extend({},h,c))}}()}),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Backbone","Vectorizer","Geometry","jQuery"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("$")||require("jQuery"),e=require("Backbone"),f=require("lodash"),g=require("V")||require("Vectorizer"),h=require("G")||require("Geometry")||require("g");b(c,f,e,g,h,d)}else{var c=a.joint,d=a.$||a.jQuery,e=a.Backbone,f=a._,g=a.V||a.Vectorizer,h=a.G||a.Geometry||a.g;b(c,f,e,g,h,d)}}(this,function(a,b,c,d,e,f){a.routers.metro=function(){if(!b.isFunction(a.routers.manhattan))throw"Metro requires the manhattan router.";var c={diagonalCost:null,directions:function(){var a=this.step,b=this.diagonalCost||Math.ceil(Math.sqrt(a*a<<1));return[{offsetX:a,offsetY:0,cost:a},{offsetX:a,offsetY:a,cost:b},{offsetX:0,offsetY:a,cost:a},{offsetX:-a,offsetY:a,cost:b},{offsetX:-a,offsetY:0,cost:a},{offsetX:-a,offsetY:-a,cost:b},{offsetX:0,offsetY:-a,cost:a},{offsetX:a,offsetY:-a,cost:b}]},fallbackRoute:function(a,b,c){var d=a.theta(b),f={x:b.x,y:a.y},g={x:a.x,y:b.y};if(d%180>90){var h=f;f=g,g=h}var i=45>d%90?f:g,j=e.line(a,i),k=90*Math.ceil(d/90),l=e.point.fromPolar(j.squaredLength(),e.toRad(k+135),i),m=e.line(b,l),n=j.intersection(m);return n?[n.round(),b]:[b]}};return function(d,e,f){return a.routers.manhattan(d,b.extend({},c,e),f)}}()}),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("lodash");b(c,d)}else{var c=a.joint,d=a._;b(c,d)}}(this,function(a,b,c,d,e,f){a.connectors.normal=function(a,c,d){var e=["M",a.x,a.y];return b.each(d,function(a){e.push(a.x,a.y)}),e.push(c.x,c.y),e.join(" ")}}),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS","lodash","Geometry"],b);else if("object"==typeof exports){var c=require("JointJS"),d=require("lodash"),e=require("G")||require("Geometry")||require("g");b(c,d,e)}else{var c=a.joint,d=a._,e=a.G||a.Geometry||a.g;b(c,d,e)}}(this,function(a,b,c){a.connectors.rounded=function(a,d,e,f){var g,h,i,j,k,l,m=f.radius||10,n=["M",a.x,a.y];return b.each(e,function(b,f){k=e[f-1]||a,l=e[f+1]||d,i=j||c.point(b).distance(k)/2,j=c.point(b).distance(l)/2,g=c.point(b).move(k,-Math.min(m,i)).round(),h=c.point(b).move(l,-Math.min(m,j)).round(),n.push(g.x,g.y,"S",b.x,b.y,h.x,h.y,"L")}),n.push(d.x,d.y),n.join(" ")}}),function(a,b){if("function"==typeof define&&define.amd)define(["JointJS"],b);else if("object"==typeof exports){var c=require("JointJS");b(c)}else{var c=a.joint;b(c)}}(this,function(a){a.connectors.smooth=function(a,b,c){var d;if(c.length)d=g.bezier.curveThroughPoints([a].concat(c).concat([b]));else{var e=a.x<b.x?b.x-(b.x-a.x)/2:a.x-(a.x-b.x)/2;d=["M",a.x,a.y,"C",e,a.y,e,b.y,b.x,b.y]}return d.join(" ")}});